name: Comment CI/CD Errors on PR

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed

permissions:
  pull-requests: write
  actions: read
  contents: read

jobs:
  comment-on-failure:
    name: Comment Error Logs on PR
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.event == 'pull_request' }}

    steps:
      - name: Get PR number
        id: pr
        run: |
          # Get PR number from workflow run
          PR_NUMBER=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" \
            --jq '.pull_requests[0].number')

          echo "PR Number: $PR_NUMBER"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download error logs (backend)
        id: download-backend
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: backend-error-logs-${{ github.event.workflow_run.id }}
          path: backend-errors
          github-token: ${{ github.token }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Download error logs (frontend)
        id: download-frontend
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: frontend-error-logs-${{ github.event.workflow_run.id }}
          path: frontend-errors
          github-token: ${{ github.token }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Analyze and format errors
        id: analyze
        run: |
          # Create error summary
          cat > error-summary.md <<'SUMMARY_EOF'
          ## üî¥ CI/CD Failed - Error Analysis

          **Workflow Run**: [#${{ github.event.workflow_run.id }}](${{ github.event.workflow_run.html_url }})
          **Commit**: ${{ github.event.workflow_run.head_sha }}
          **Branch**: ${{ github.event.workflow_run.head_branch }}

          ---

          SUMMARY_EOF

          # Analyze backend errors
          if [ -d "backend-errors" ]; then
            echo "### üêç Backend Errors" >> error-summary.md
            echo "" >> error-summary.md

            if [ -f "backend-errors/pytest-errors.log" ]; then
              echo "<details>" >> error-summary.md
              echo "<summary>üìù Pytest Errors (click to expand)</summary>" >> error-summary.md
              echo "" >> error-summary.md
              echo '```python' >> error-summary.md
              tail -n 100 backend-errors/pytest-errors.log >> error-summary.md
              echo '```' >> error-summary.md
              echo "</details>" >> error-summary.md
              echo "" >> error-summary.md
            fi

            if [ -f "backend-errors/ruff-errors.log" ]; then
              echo "<details>" >> error-summary.md
              echo "<summary>üîç Ruff Linter Errors (click to expand)</summary>" >> error-summary.md
              echo "" >> error-summary.md
              echo '```' >> error-summary.md
              cat backend-errors/ruff-errors.log >> error-summary.md
              echo '```' >> error-summary.md
              echo "</details>" >> error-summary.md
              echo "" >> error-summary.md
            fi

            if [ -f "backend-errors/mypy-errors.log" ]; then
              echo "<details>" >> error-summary.md
              echo "<summary>üî§ MyPy Type Errors (click to expand)</summary>" >> error-summary.md
              echo "" >> error-summary.md
              echo '```' >> error-summary.md
              cat backend-errors/mypy-errors.log >> error-summary.md
              echo '```' >> error-summary.md
              echo "</details>" >> error-summary.md
              echo "" >> error-summary.md
            fi
          fi

          # Analyze frontend errors
          if [ -d "frontend-errors" ]; then
            echo "### ‚öõÔ∏è Frontend Errors" >> error-summary.md
            echo "" >> error-summary.md

            if [ -f "frontend-errors/lint-errors.log" ]; then
              echo "<details>" >> error-summary.md
              echo "<summary>üîç ESLint Errors (click to expand)</summary>" >> error-summary.md
              echo "" >> error-summary.md
              echo '```javascript' >> error-summary.md
              cat frontend-errors/lint-errors.log >> error-summary.md
              echo '```' >> error-summary.md
              echo "</details>" >> error-summary.md
              echo "" >> error-summary.md
            fi

            if [ -f "frontend-errors/typescript-errors.log" ]; then
              echo "<details>" >> error-summary.md
              echo "<summary>üî§ TypeScript Errors (click to expand)</summary>" >> error-summary.md
              echo "" >> error-summary.md
              echo '```typescript' >> error-summary.md
              tail -n 100 frontend-errors/typescript-errors.log >> error-summary.md
              echo '```' >> error-summary.md
              echo "</details>" >> error-summary.md
              echo "" >> error-summary.md
            fi

            if [ -f "frontend-errors/build-errors.log" ]; then
              echo "<details>" >> error-summary.md
              echo "<summary>üî® Build Errors (click to expand)</summary>" >> error-summary.md
              echo "" >> error-summary.md
              echo '```' >> error-summary.md
              tail -n 100 frontend-errors/build-errors.log >> error-summary.md
              echo '```' >> error-summary.md
              echo "</details>" >> error-summary.md
              echo "" >> error-summary.md
            fi
          fi

          # Add suggestions for Claude Code
          cat >> error-summary.md <<'SUGGESTIONS_EOF'

          ---

          ### üí° Suggested Actions for Claude Code

          1. **Analyze the errors** above and identify the root cause
          2. **Fix the issues** in the codebase
          3. **Run tests locally** to verify the fixes
          4. **Push the changes** to update this PR

          ### üîß Quick Fix Commands

          ```bash
          # Backend fixes
          cd backend
          ruff check --fix .
          ruff format .
          mypy app/

          # Frontend fixes
          cd frontend
          npm run lint -- --fix
          npx tsc --noEmit
          ```

          ---

          <sub>ü§ñ This comment was automatically generated by the CI/CD error analysis system</sub>
          SUGGESTIONS_EOF

          echo "Error summary created"
          cat error-summary.md

      - name: Find existing comment
        id: find-comment
        if: steps.pr.outputs.pr_number != ''
        run: |
          COMMENT_ID=$(gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/issues/${{ steps.pr.outputs.pr_number }}/comments" \
            --jq '.[] | select(.body | contains("CI/CD Failed - Error Analysis")) | .id' \
            | head -n 1)

          echo "Existing comment ID: $COMMENT_ID"
          echo "comment_id=$COMMENT_ID" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Post or update comment
        if: steps.pr.outputs.pr_number != ''
        run: |
          if [ -n "${{ steps.find-comment.outputs.comment_id }}" ]; then
            # Update existing comment
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/issues/comments/${{ steps.find-comment.outputs.comment_id }}" \
              -f body="$(cat error-summary.md)"
            echo "Updated existing comment"
          else
            # Create new comment
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/issues/${{ steps.pr.outputs.pr_number }}/comments" \
              -f body="$(cat error-summary.md)"
            echo "Created new comment"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
