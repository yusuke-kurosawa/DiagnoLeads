name: Database Integrity Check

on:
  pull_request:
    paths:
      - 'backend/app/models/**'
      - 'backend/alembic/versions/**'
      - 'openspec/specs/database/**'
      - 'backend/scripts/validate_database_integrity.py'

jobs:
  validate-schema:
    name: Validate Database Schema
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: diagnoleads_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´å–å¾—ï¼ˆå·®åˆ†æ¯”è¼ƒç”¨ï¼‰
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install dependencies
        working-directory: backend
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install pyyaml
      
      - name: Run migrations
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/diagnoleads_test
          SECRET_KEY: test-secret-key-for-ci
          ENVIRONMENT: test
        run: |
          echo "ğŸ”§ Running database migrations..."
          alembic upgrade head
          echo "âœ… Migrations completed"
      
      - name: Validate database integrity
        id: integrity_check
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/diagnoleads_test
          SECRET_KEY: test-secret-key-for-ci
          ENVIRONMENT: test
        run: |
          echo "ğŸ” Validating database integrity..."
          python scripts/validate_database_integrity.py
      
      - name: Check for migration conflicts
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/diagnoleads_test
        run: |
          echo "ğŸ” Checking for migration conflicts..."
          heads=$(alembic heads | wc -l)
          if [ $heads -gt 1 ]; then
            echo "âŒ è¤‡æ•°ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³headãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            alembic heads
            exit 1
          fi
          echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³headã¯1ã¤ã§ã™"
      
      - name: Verify migration reversibility
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/diagnoleads_test
          SECRET_KEY: test-secret-key-for-ci
          ENVIRONMENT: test
        run: |
          echo "ğŸ”„ Testing migration rollback..."
          current=$(alembic current)
          if [ -n "$current" ]; then
            alembic downgrade -1
            alembic upgrade head
            echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã™"
          else
            echo "â„¹ï¸  é©ç”¨æ¸ˆã¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“"
          fi
      
      - name: Comment on PR (Success)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Database Integrity Check - PASSED**\n\n' +
                    '- âœ“ Database migrations applied successfully\n' +
                    '- âœ“ Database integrity validated\n' +
                    '- âœ“ No migration conflicts detected\n' +
                    '- âœ“ Migration rollback verified\n\n' +
                    'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®æ•´åˆæ€§ãŒç¢ºèªã•ã‚Œã¾ã—ãŸã€‚'
            })
      
      - name: Comment on PR (Failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Database Integrity Check - FAILED**\n\n' +
                    'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' +
                    'è©³ç´°ã¯CI/CDãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n' +
                    '### ã‚ˆãã‚ã‚‹å•é¡Œ:\n' +
                    '- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã® `ondelete` è¨­å®šãŒä¸é©åˆ‡\n' +
                    '- å­¤å…ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹\n' +
                    '- ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã« `back_populates` ãŒæœªè¨­å®š\n' +
                    '- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ç«¶åˆ\n\n' +
                    'ä¿®æ­£å¾Œã€å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚'
            })
