# Feature Proposal: Database Integrity Management System

## Why
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã€ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãŒåŽ³å¯†ã«ç®¡ç†ã•ã‚Œã¦ã„ãªã„ç¾çŠ¶ã§ã¯ã€ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ï¼š

- **å­¤å…ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆOrphan Recordsï¼‰ã®ç™ºç”Ÿ**: è¦ªãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤å¾Œã‚‚å­ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæ®‹ã‚‹
- **å‚ç…§æ•´åˆæ€§é•å**: å­˜åœ¨ã—ãªã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã¸ã®å‚ç…§
- **CASCADE/SET NULLã®ä¸ä¸€è‡´**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨å¤–éƒ¨ã‚­ãƒ¼å‹•ä½œã®ä¹–é›¢
- **ãƒ‡ãƒ¼ã‚¿å“è³ªã®ä½Žä¸‹**: ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã®è“„ç©
- **ãƒ‡ãƒãƒƒã‚°ã®å›°é›£åŒ–**: ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆã«ã‚ˆã‚‹ãƒã‚°ã®ç‰¹å®šãŒå›°é›£

ç¾åœ¨ã€ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ `ondelete="CASCADE"` ã¨ `ondelete="SET NULL"` ãŒæ··åœ¨ã—ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã‚‰ã®é¸æŠžãŒãƒ“ã‚¸ãƒã‚¹è¦ä»¶ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã€ç¶™ç¶šçš„ã«æ¤œè¨¼ã™ã‚‹ä»•çµ„ã¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

## What Changes
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒžã®å“è³ªã‚’ç¶™ç¶šçš„ã«ä¿è¨¼ã™ã‚‹åŒ…æ‹¬çš„ãªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆä»•æ§˜ã®å®šç¾©
`openspec/specs/database/schema-constraints.yml` ã«ã¦ä»¥ä¸‹ã‚’å®šç¾©ï¼š
- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãƒ«ãƒ¼ãƒ«ï¼ˆCASCADE/SET NULL/RESTRICTï¼‰ã¨ãã®ç†ç”±
- ä¸€æ„åˆ¶ç´„ã®å®šç¾©
- ãƒã‚§ãƒƒã‚¯åˆ¶ç´„ã®å®šç¾©
- æŽ¨å¥¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
`backend/scripts/validate_database_integrity.py` ã‚’ä½œæˆï¼š
- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®å­˜åœ¨ã¨ ondelete å‹•ä½œã®æ¤œè¨¼
- å­¤å…ãƒ¬ã‚³ãƒ¼ãƒ‰ã®è‡ªå‹•æ¤œå‡º
- ä¸€æ„åˆ¶ç´„é•åã®ãƒã‚§ãƒƒã‚¯
- ãƒã‚§ãƒƒã‚¯åˆ¶ç´„é•åã®æ¤œå‡º
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å­˜åœ¨ç¢ºèª
- SQLAlchemy ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã®åŒæ–¹å‘æ€§æ¤œè¨¼

### 3. CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¸ã®çµ±åˆ
`.github/workflows/database-integrity.yml` ã‚’ä½œæˆï¼š
- PRã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ã‚’è‡ªå‹•æ¤œè¨¼
- ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç«¶åˆã®æ¤œå‡º
- ERå›³ã¨ã‚¹ã‚­ãƒ¼ãƒžã®åŒæœŸç¢ºèª
- æ¤œè¨¼å¤±æ•—æ™‚ã¯PRãƒžãƒ¼ã‚¸ã‚’ãƒ–ãƒ­ãƒƒã‚¯

### 4. ERå›³ã®è‡ªå‹•ç”Ÿæˆãƒ»åŒæœŸ
`backend/scripts/generate_er_diagram.py` ã‚’ä½œæˆï¼š
- å®Ÿéš›ã®ã‚¹ã‚­ãƒ¼ãƒžã‹ã‚‰Mermaidå½¢å¼ã®ERå›³ã‚’è‡ªå‹•ç”Ÿæˆ
- ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«è‡ªå‹•æ›´æ–°
- æ‰‹å‹•æ›´æ–°ã¨ã®ä¹–é›¢ã‚’æ¤œå‡º

### 5. OpenAPI + Zodã‚¹ã‚­ãƒ¼ãƒžã®çµ±åˆæ¤œè¨¼
`frontend/src/schemas/*.test.ts` ã‚’è¿½åŠ ï¼š
- Zodã‚¹ã‚­ãƒ¼ãƒžã¨ OpenAPIåž‹ã®æ•´åˆæ€§ãƒ†ã‚¹ãƒˆ
- ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚åž‹ãƒã‚§ãƒƒã‚¯ã®äºŒé‡ä¿è¨¼

### 6. Spectralã«ã‚ˆã‚‹åŽ³æ ¼ãªOpenAPIæ¤œè¨¼
`.spectral.yml` ã‚’ä½œæˆï¼š
- Multi-tenantå¯¾å¿œã®æ¤œè¨¼ï¼ˆå…¨ãƒ‘ã‚¹ã« tenant_id å¿…é ˆï¼‰
- operationIdå‘½åè¦å‰‡ã®å¼·åˆ¶
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ã‚­ãƒ¼ãƒžå¿…é ˆåŒ–
- ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¨™æº–åŒ–

### 7. Breaking Changeè‡ªå‹•æ¤œå‡º
`oasdiff` ã‚’ä½¿ç”¨ã—ã¦OpenAPIä»•æ§˜ã®ç ´å£Šçš„å¤‰æ›´ã‚’æ¤œå‡ºï¼š
- APIã®å¾Œæ–¹äº’æ›æ€§ã‚’ä¿è¨¼
- æ„å›³ã—ãªã„ç ´å£Šçš„å¤‰æ›´ã‚’äº‹å‰ã«æ¤œå‡º

### 8. PRä½œæˆãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã®æ¨™æº–åŒ–
- PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä½œæˆ
- è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
- ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…é ˆé …ç›®ã®æ˜Žç¢ºåŒ–

## User Stories

### é–‹ç™ºè€…ã¨ã—ã¦
- ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹éš›ã€å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹è‡ªå‹•ã§ç¢ºèªã•ã‚ŒãŸã„
- PRã‚’ä½œæˆã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ãŒè‡ªå‹•æ¤œè¨¼ã•ã‚Œã€å•é¡ŒãŒã‚ã‚Œã°æŒ‡æ‘˜ã•ã‚ŒãŸã„
- å­¤å…ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€å³åº§ã«æ¤œå‡ºã•ã‚ŒãŸã„

### ãƒ†ãƒƒã‚¯ãƒªãƒ¼ãƒ‰ã¨ã—ã¦
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã®æ„å›³ï¼ˆãªãœCASCADEãªã®ã‹ï¼‰ãŒæ˜Žæ–‡åŒ–ã•ã‚Œã€ãƒãƒ¼ãƒ ã§å…±æœ‰ã•ã‚ŒãŸã„
- æ–°ã—ã„ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ—¢å­˜ã®ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã«é•åã—ã¦ã„ãªã„ã‹ç¢ºèªã—ãŸã„
- ERå›³ãŒå¸¸ã«æœ€æ–°ã®çŠ¶æ…‹ã«ä¿ãŸã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ãŸã„

### QAã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦
- ãƒ‡ãƒ¼ã‚¿å“è³ªã«é–¢ã™ã‚‹å•é¡ŒãŒæœ¬ç•ªç’°å¢ƒã«åˆ°é”ã™ã‚‹å‰ã«æ¤œå‡ºã•ã‚ŒãŸã„
- ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã„

## Requirements

### Functional Requirements

#### FR-1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆä»•æ§˜ã®ç®¡ç†
- YAMLå½¢å¼ã§å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã§ãã‚‹ã“ã¨
- å„åˆ¶ç´„ã«ã¤ã„ã¦ã€Œãªãœãã®è¨­å®šãªã®ã‹ã€ã‚’ç†ç”±ã¨ã¨ã‚‚ã«è¨˜è¿°ã§ãã‚‹ã“ã¨
- ãƒã‚§ãƒƒã‚¯åˆ¶ç´„ã€ä¸€æ„åˆ¶ç´„ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ã‚’å«ã‚€ã“ã¨

#### FR-2: è‡ªå‹•æ•´åˆæ€§æ¤œè¨¼
- ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå¾Œã€è‡ªå‹•çš„ã«æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨
- ä»¥ä¸‹ã®é …ç›®ã‚’æ¤œè¨¼ã™ã‚‹ã“ã¨ï¼š
  - å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®å­˜åœ¨ã¨ ondelete å‹•ä½œ
  - å­¤å…ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æœ‰ç„¡
  - ä¸€æ„åˆ¶ç´„é•å
  - ãƒã‚§ãƒƒã‚¯åˆ¶ç´„é•å
  - æŽ¨å¥¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å­˜åœ¨
  - SQLAlchemyãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã®åŒæ–¹å‘æ€§

#### FR-3: CI/CDçµ±åˆ
- PRä½œæˆæ™‚ã«è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
- ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç«¶åˆã‚’è‡ªå‹•æ¤œå‡º
- ERå›³ã®åŒæœŸçŠ¶æ…‹ã‚’ç¢ºèª
- æ¤œè¨¼å¤±æ•—æ™‚ã¯PRã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’failedã«è¨­å®š

#### FR-4: ERå›³ã®è‡ªå‹•ç”Ÿæˆ
- å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒžã‹ã‚‰ERå›³ã‚’ç”Ÿæˆ
- Mermaidå½¢å¼ã§å‡ºåŠ›
- ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã®ç¨®é¡žï¼ˆCASCADE/SET NULLï¼‰ã‚’æ˜Žç¤º

#### FR-5: OpenAPI Breaking Changeæ¤œå‡º
- oasdiffã‚’ä½¿ç”¨ã—ã¦APIã®ç ´å£Šçš„å¤‰æ›´ã‚’æ¤œå‡º
- PRä½œæˆæ™‚ã«è‡ªå‹•ãƒã‚§ãƒƒã‚¯
- ç ´å£Šçš„å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯æ˜Žç¢ºã«è­¦å‘Š

#### FR-6: Spectralã«ã‚ˆã‚‹åŽ³æ ¼ãªæ¤œè¨¼
- Multi-tenantå¯¾å¿œã®å¼·åˆ¶ï¼ˆå…¨ãƒ‘ã‚¹ã« tenant_idï¼‰
- operationIdå‘½åè¦å‰‡ã®æ¤œè¨¼
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ã‚­ãƒ¼ãƒžã®å¿…é ˆåŒ–
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®šç¾©ã®æ¤œè¨¼

### Non-Functional Requirements

#### NFR-1: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹
- æ•´åˆæ€§æ¤œè¨¼ã¯5åˆ†ä»¥å†…ã«å®Œäº†ã™ã‚‹ã“ã¨
- CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å…¨ä½“ã®å®Ÿè¡Œæ™‚é–“ã‚’20%ä»¥ä¸Šå¢—åŠ ã•ã›ãªã„ã“ã¨

#### NFR-2: ä¿å®ˆæ€§
- æ¤œè¨¼ãƒ«ãƒ¼ãƒ«ã¯YAMLã§ç®¡ç†ã—ã€ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—ã§æ›´æ–°å¯èƒ½ã§ã‚ã‚‹ã“ã¨
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å…·ä½“çš„ã§ã€ä¿®æ­£æ–¹æ³•ã‚’ç¤ºå”†ã™ã‚‹ã“ã¨

#### NFR-3: æ‹¡å¼µæ€§
- æ–°ã—ã„æ¤œè¨¼ãƒ«ãƒ¼ãƒ«ã‚’å®¹æ˜“ã«è¿½åŠ ã§ãã‚‹ã“ã¨
- ã‚«ã‚¹ã‚¿ãƒ ãƒã‚§ãƒƒã‚¯åˆ¶ç´„ã‚’å®šç¾©å¯èƒ½ã§ã‚ã‚‹ã“ã¨

#### NFR-4: å¯è¦–æ€§
- CI/CDã®å„ãƒã‚§ãƒƒã‚¯çµæžœã‚’PRã‚³ãƒ¡ãƒ³ãƒˆã§å¯è¦–åŒ–
- æ¤œè¨¼å¤±æ•—æ™‚ã¯å…·ä½“çš„ãªä¿®æ­£æ‰‹é †ã‚’æç¤º

## API Design

æœ¬æ©Ÿèƒ½ã¯å†…éƒ¨ãƒ„ãƒ¼ãƒ«ã®ãŸã‚ã€å¤–éƒ¨APIã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

## Data Model

æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¿½åŠ ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒžã®å“è³ªã‚’ä¿è¨¼ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

## UI/UX Design

### PRç”»é¢ã§ã®è¡¨ç¤º
```
âœ… Database Integrity Check - PASSED
  âœ“ Foreign key constraints validated
  âœ“ No orphan records found
  âœ“ Unique constraints verified
  âœ“ Check constraints verified
  âœ“ Recommended indexes present
  âœ“ Relationship bidirectionality confirmed

âœ… OpenAPI Specification - PASSED
  âœ“ No breaking changes detected
  âœ“ Spectral validation passed
  âœ“ Types are up to date

âœ… ER Diagram - PASSED
  âœ“ ER diagram matches current schema
```

### æ¤œè¨¼å¤±æ•—æ™‚ã®è¡¨ç¤º
```
âŒ Database Integrity Check - FAILED

Errors:
  - leads.created_by -> users: Expected ondelete=SET NULL, Actual: ondelete=CASCADE
  - 15 orphan records found in answers table
  - leads.score: 3 records violate check constraint (score >= 0 AND score <= 100)

âš ï¸  Warnings:
  - Missing recommended index on leads(tenant_id, created_at)
  - Question.options relationship missing back_populates

ðŸ“‹ Action Required:
  1. Review backend/alembic/versions/xxxxx_migration.py
  2. Update ondelete behavior for leads.created_by
  3. Clean up orphan records: python scripts/cleanup_orphans.py
  4. Add missing index: alembic revision -m "add_missing_indexes"
```

## Business Logic

### å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®æ±ºå®šãƒ•ãƒ­ãƒ¼
1. **CASCADE**: è¦ªã®å‰Šé™¤ã¨åŒæ™‚ã«å­ã‚‚å‰Šé™¤ã™ã¹ãå ´åˆ
   - ä¾‹: ãƒ†ãƒŠãƒ³ãƒˆå‰Šé™¤æ™‚ã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿
   - ä¾‹: ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆå‰Šé™¤æ™‚ã®è³ªå•ãƒ»å›žç­”

2. **SET NULL**: è¦ªãŒå‰Šé™¤ã•ã‚Œã¦ã‚‚å­ã¯ä¿æŒã™ã¹ãå ´åˆ
   - ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤å¾Œã‚‚ãã®ä½œæˆã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ä¿æŒï¼ˆåŒ¿ååŒ–ï¼‰
   - ä¾‹: ãƒªãƒ¼ãƒ‰å‰Šé™¤å¾Œã‚‚ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ã¯ä¿æŒï¼ˆåˆ†æžç”¨ï¼‰

3. **RESTRICT**: å­ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯è¦ªã‚’å‰Šé™¤ã§ããªã„
   - ä¾‹: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ãƒ†ãƒŠãƒ³ãƒˆ

### å­¤å…ãƒ¬ã‚³ãƒ¼ãƒ‰æ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯
```sql
-- ä¾‹: TenantsãŒå‰Šé™¤ã•ã‚ŒãŸå¾Œã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
SELECT COUNT(*) FROM users 
WHERE tenant_id NOT IN (SELECT id FROM tenants);

-- ä¾‹: AssessmentsãŒå‰Šé™¤ã•ã‚ŒãŸå¾Œã®Questions
SELECT COUNT(*) FROM questions 
WHERE assessment_id NOT IN (SELECT id FROM assessments);
```

## Testing Strategy

### Unit Tests
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å„é–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆ
- æ§˜ã€…ãªåˆ¶ç´„é•åãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ

### Integration Tests
- å®Ÿéš›ã®ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆ
- å­¤å…ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆâ†’æ¤œå‡ºã®E2Eãƒ†ã‚¹ãƒˆ
- ERå›³ç”Ÿæˆã®æ­£ç¢ºæ€§ãƒ†ã‚¹ãƒˆ

### CI Tests
- PRã”ã¨ã«è‡ªå‹•å®Ÿè¡Œ
- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨
- æ¤œè¨¼çµæžœã®ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

## Implementation Notes

### Phase 1: åŸºç›¤æ§‹ç¯‰ï¼ˆå³åº§ã«å®Ÿæ–½ï¼‰
1. `openspec/specs/database/schema-constraints.yml` ä½œæˆ
2. `backend/scripts/validate_database_integrity.py` ä½œæˆ
3. `.github/workflows/database-integrity.yml` ä½œæˆ
4. PR ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ

### Phase 2: OpenAPIçµ±åˆï¼ˆ1é€±é–“å¾Œï¼‰
1. `.spectral.yml` ä½œæˆ
2. Breaking Changeæ¤œå‡ºã®è¿½åŠ 
3. Zodã‚¹ã‚­ãƒ¼ãƒžãƒ†ã‚¹ãƒˆã®è¿½åŠ 

### Phase 3: è‡ªå‹•åŒ–å¼·åŒ–ï¼ˆ2é€±é–“å¾Œï¼‰
1. ERå›³è‡ªå‹•ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
2. ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆæ™‚ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯
3. è‡ªå‹•ä¿®æ­£ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆå¯èƒ½ãªç¯„å›²ï¼‰

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **æ¤œè¨¼**: SQLAlchemy Inspector, PostgreSQL metadata queries
- **CI/CD**: GitHub Actions
- **OpenAPIæ¤œè¨¼**: Spectral CLI, oasdiff
- **ERå›³ç”Ÿæˆ**: Mermaid, PlantUML
- **è¨­å®šç®¡ç†**: YAML

### åˆ¶ç´„ãƒ»æ³¨æ„äº‹é …
- å¤§è¦æ¨¡ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã¯æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã«æ™‚é–“ãŒã‹ã‹ã‚‹å¯èƒ½æ€§
- æ—¢å­˜ã®å­¤å…ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã€æ‰‹å‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå¿…è¦
- Breaking Changeã®æ¤œå‡ºã¯è‡ªå‹•ã ãŒã€ä¿®æ­£ã¯æ‰‹å‹•

## Related Specs
- [Database ER Diagram System](../database/er-diagram-system.md)
- [Multi-tenant Architecture](../auth/multi-tenant.md)
- [OpenAPI Integration](../../README.openspec.md)

## Success Metrics
- ðŸŽ¯ å­¤å…ãƒ¬ã‚³ãƒ¼ãƒ‰ç™ºç”ŸçŽ‡: 0ä»¶/æœˆ
- ðŸŽ¯ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ•´åˆæ€§é•å: 0ä»¶/ãƒªãƒªãƒ¼ã‚¹
- ðŸŽ¯ PRä½œæˆã‹ã‚‰ãƒžãƒ¼ã‚¸ã¾ã§ã®å¹³å‡æ™‚é–“: ç¾çŠ¶ç¶­æŒ
- ðŸŽ¯ æœ¬ç•ªç’°å¢ƒã§ã®ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚¨ãƒ©ãƒ¼: 90%å‰Šæ¸›

## Risks & Mitigations

### ãƒªã‚¹ã‚¯1: CI/CDå®Ÿè¡Œæ™‚é–“ã®å¢—åŠ 
- **å½±éŸ¿**: é–‹ç™ºé€Ÿåº¦ã®ä½Žä¸‹
- **å¯¾ç­–**: ä¸¦åˆ—å®Ÿè¡Œã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨ã€æ®µéšŽçš„ãƒã‚§ãƒƒã‚¯

### ãƒªã‚¹ã‚¯2: æ—¢å­˜ã®å­¤å…ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å¤§é‡æ¤œå‡º
- **å½±éŸ¿**: åˆå›žå°Žå…¥æ™‚ã«PRãŒã™ã¹ã¦å¤±æ•—
- **å¯¾ç­–**: è­¦å‘Šãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹ã€æ®µéšŽçš„ã«åŽ³æ ¼åŒ–

### ãƒªã‚¹ã‚¯3: False Positiveï¼ˆèª¤æ¤œå‡ºï¼‰
- **å½±éŸ¿**: æ­£å¸¸ãªPRãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹
- **å¯¾ç­–**: æ¤œè¨¼ãƒ«ãƒ¼ãƒ«ã®ç¶™ç¶šçš„ãªæ”¹å–„ã€é™¤å¤–è¨­å®šã®æä¾›

## Next Steps
1. ã“ã®Proposalã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ‰¿èª
2. Phase 1ã®å®Ÿè£…é–‹å§‹
3. ãƒ†ã‚¹ãƒˆç’°å¢ƒã§æ¤œè¨¼
4. æ®µéšŽçš„ã«æœ¬ç•ªé©ç”¨
