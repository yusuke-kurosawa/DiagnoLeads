# Feature Specification: System Core Features

**Version**: 1.0  
**Status**: Proposal  
**Last Updated**: 2025-11-11  
**Related Proposal**: [core-features-proposal.md](./core-features-proposal.md)

---

## Overview

DiagnoLeadsã®ã‚·ã‚¹ãƒ†ãƒ å…±é€šæ©Ÿèƒ½ã‚’å®šç¾©ã—ã¾ã™ã€‚å…¨ãƒšãƒ¼ã‚¸ã§å…±æœ‰ã•ã‚Œã‚‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã€ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’å«ã¿ã¾ã™ã€‚

---

## User Stories

### US-CORE-1: ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
**As a** ãƒ†ãƒŠãƒ³ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼  
**I want to** ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰å„æ©Ÿèƒ½ã«ç°¡å˜ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹  
**So that** åŠ¹ç‡çš„ã«ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆ©ç”¨ã§ãã‚‹

**Acceptance Criteria:**
- [ ] ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€è¨ºæ–­ç®¡ç†ã€ãƒªãƒ¼ãƒ‰ç®¡ç†ã€åˆ†æã€è¨­å®šï¼‰
- [ ] ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã•ã‚Œã‚‹
- [ ] ã‚¢ã‚¤ã‚³ãƒ³ + ãƒ©ãƒ™ãƒ«ã§è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ã„
- [ ] ãƒ›ãƒãƒ¼æ™‚ã«ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º
- [ ] ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼

### US-CORE-2: ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ
**As a** ãƒ¦ãƒ¼ã‚¶ãƒ¼  
**I want to** ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®éšå±¤æ§‹é€ ã‚’ç†è§£ã§ãã‚‹  
**So that** è¿·ã‚ãšã«ä¸Šä½ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Œã‚‹

**Acceptance Criteria:**
- [ ] ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã«ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆè¡¨ç¤º
- [ ] ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªãƒªãƒ³ã‚¯
- [ ] éšå±¤æ§‹é€ ã‚’æ­£ã—ãè¡¨ç¤ºï¼ˆä¾‹: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ > è¨ºæ–­ç®¡ç† > è¨ºæ–­ç·¨é›†ï¼‰

### US-CORE-3: èªè¨¼ä¿è­·
**As a** ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…  
**I want to** æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¿è­·ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‚ˆã†ã«ã—ãŸã„  
**So that** ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¢ºä¿ã§ãã‚‹

**Acceptance Criteria:**
- [ ] ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„çŠ¶æ…‹ã§ä¿è­·ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ `/login` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- [ ] ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€å…ƒã®ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- [ ] ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãŒãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¾Œã‚‚ä¿æŒã•ã‚Œã‚‹
- [ ] ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã€ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒã‚¯ãƒªã‚¢ã•ã‚Œã‚‹

### US-CORE-4: ãƒ†ãƒŠãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆ
**As a** ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆç®¡ç†è€…  
**I want to** ç®¡ç†å¯¾è±¡ã®ãƒ†ãƒŠãƒ³ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹  
**So that** è¤‡æ•°ã®ãƒ†ãƒŠãƒ³ãƒˆã‚’åŠ¹ç‡çš„ã«ç®¡ç†ã§ãã‚‹

**Acceptance Criteria:**
- [ ] ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ†ãƒŠãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¡¨ç¤º
- [ ] ãƒ†ãƒŠãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆæ™‚ã€URLã¨è¡¨ç¤ºå†…å®¹ãŒæ›´æ–°ã•ã‚Œã‚‹
- [ ] åˆ‡ã‚Šæ›¿ãˆãŸãƒ†ãƒŠãƒ³ãƒˆãŒæ¬¡å›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãªã‚‹

---

## Functional Requirements

### FR-CORE-1: Layout Structure

**ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹é€ :**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header (Logo, Tenant Switcher, User Menu)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚  Breadcrumbs                         â”‚
â”‚ Sidebar â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚         â”‚                                      â”‚
â”‚ - Home  â”‚  Main Content Area                  â”‚
â”‚ - è¨ºæ–­   â”‚                                      â”‚
â”‚ - ãƒªãƒ¼ãƒ‰ â”‚                                      â”‚
â”‚ - åˆ†æ   â”‚                                      â”‚
â”‚ - è¨­å®š   â”‚                                      â”‚
â”‚         â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Responsive Behavior:**
- **Desktop (>= 1024px)**: Sidebarå¸¸æ™‚è¡¨ç¤º
- **Tablet (768px - 1023px)**: SidebaræŠ˜ã‚ŠãŸãŸã¿å¯èƒ½
- **Mobile (< 768px)**: Sidebarã¯ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼

### FR-CORE-2: Navigation Items

| ã‚¢ã‚¤ã‚³ãƒ³ | ãƒ©ãƒ™ãƒ« | ãƒ‘ã‚¹ | èª¬æ˜ |
|---------|-------|------|------|
| ğŸ  | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | `/dashboard` | æ¦‚è¦ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ |
| ğŸ“‹ | è¨ºæ–­ç®¡ç† | `/tenants/:tenantId/assessments` | è¨ºæ–­ã®ä½œæˆãƒ»ç·¨é›† |
| ğŸ‘¥ | ãƒªãƒ¼ãƒ‰ç®¡ç† | `/tenants/:tenantId/leads` | ãƒªãƒ¼ãƒ‰ä¸€è¦§ãƒ»ç®¡ç† |
| ğŸ“Š | åˆ†æ | `/tenants/:tenantId/analytics` | åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ |
| âš™ï¸ | è¨­å®š | `/tenants/:tenantId/settings` | ãƒ†ãƒŠãƒ³ãƒˆè¨­å®š |

### FR-CORE-3: Route Protection

**Public Routes (èªè¨¼ä¸è¦):**
- `/login`
- `/register`
- `/forgot-password`

**Protected Routes (èªè¨¼å¿…é ˆ):**
- ã™ã¹ã¦ã® `/tenants/:tenantId/*` ãƒ‘ã‚¹
- `/dashboard`

**Route Guards:**
```typescript
// Middleware logic
if (!isAuthenticated && isProtectedRoute) {
  redirect(`/login?returnUrl=${currentPath}`);
}

if (isAuthenticated && isPublicRoute) {
  redirect('/dashboard');
}
```

### FR-CORE-4: Breadcrumbs Generation

**å‹•çš„ç”Ÿæˆãƒ«ãƒ¼ãƒ«:**
```typescript
// ä¾‹: /tenants/abc123/assessments/xyz789/edit
Breadcrumbs: [
  { label: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', path: '/dashboard' },
  { label: 'è¨ºæ–­ç®¡ç†', path: '/tenants/abc123/assessments' },
  { label: 'è¨ºæ–­å', path: '/tenants/abc123/assessments/xyz789' },
  { label: 'ç·¨é›†', path: null }, // ç¾åœ¨ãƒšãƒ¼ã‚¸ã¯ãƒªãƒ³ã‚¯ãªã—
]
```

---

## Non-Functional Requirements

### NFR-CORE-1: Performance
- åˆå›ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ < 2ç§’
- ãƒšãƒ¼ã‚¸é·ç§» < 500ms
- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒªãƒƒã‚¯å¿œç­” < 100ms

### NFR-CORE-2: Accessibility
- WCAG 2.1 AAæº–æ‹ 
- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
- ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å¯¾å¿œ
- ARIAãƒ©ãƒ™ãƒ«é©ç”¨

### NFR-CORE-3: Browser Support
- Chrome (æœ€æ–°2ãƒãƒ¼ã‚¸ãƒ§ãƒ³)
- Firefox (æœ€æ–°2ãƒãƒ¼ã‚¸ãƒ§ãƒ³)
- Safari (æœ€æ–°2ãƒãƒ¼ã‚¸ãƒ§ãƒ³)
- Edge (æœ€æ–°2ãƒãƒ¼ã‚¸ãƒ§ãƒ³)

### NFR-CORE-4: Security
- XSSå¯¾ç­–ï¼ˆReactã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
- CSRFå¯¾ç­–ï¼ˆJWTèªè¨¼ï¼‰
- ã‚»ã‚­ãƒ¥ã‚¢ãªã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- HTTPSã®ã¿è¨±å¯ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

---

## API Integration

### Auth Check API
```
GET /api/v1/auth/me
Response: {
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "ãƒ¦ãƒ¼ã‚¶ãƒ¼å",
    "role": "tenant_admin",
    "tenant_id": "uuid"
  }
}
```

### Tenant List API (for multi-tenant users)
```
GET /api/v1/users/me/tenants
Response: {
  "tenants": [
    {
      "id": "uuid",
      "name": "ãƒ†ãƒŠãƒ³ãƒˆå",
      "slug": "tenant-slug"
    }
  ]
}
```

---

## UI/UX Design

### Sidebar Design

**Desktop:**
- Width: 256px
- Background: `bg-gray-900`
- Active item: `bg-blue-600 text-white`
- Hover: `bg-gray-800`

**Mobile:**
- Overlay modal
- Full screen width
- Close button (X) in top-right
- Backdrop click to close

### Header Design
- Height: 64px
- Logo + Tenant Switcher (left)
- User menu (right)
  - User name
  - Dropdown: Profile, Settings, Logout

### Breadcrumbs Design
- Font size: 14px
- Separator: `/`
- Current page: Bold, not clickable
- Previous pages: Clickable links

---

## Component Structure

### Layout Component
```typescript
// frontend/src/components/layout/Layout.tsx
interface LayoutProps {
  children: React.ReactNode;
}

export function Layout({ children }: LayoutProps) {
  return (
    <div className="min-h-screen flex">
      <Sidebar />
      <div className="flex-1 flex flex-col">
        <Header />
        <Breadcrumbs />
        <main className="flex-1 p-6">
          {children}
        </main>
      </div>
    </div>
  );
}
```

### Sidebar Component
```typescript
// frontend/src/components/layout/Sidebar.tsx
interface NavigationItem {
  icon: React.ComponentType;
  label: string;
  path: string;
  badge?: number; // Optional notification badge
}

export function Sidebar() {
  const items: NavigationItem[] = [
    { icon: HomeIcon, label: 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰', path: '/dashboard' },
    // ... more items
  ];
  
  return (
    <aside className="w-64 bg-gray-900 text-white">
      {items.map(item => (
        <NavLink key={item.path} to={item.path}>
          <item.icon />
          <span>{item.label}</span>
          {item.badge && <Badge>{item.badge}</Badge>}
        </NavLink>
      ))}
    </aside>
  );
}
```

### Breadcrumbs Component
```typescript
// frontend/src/components/layout/Breadcrumbs.tsx
interface BreadcrumbItem {
  label: string;
  path: string | null;
}

export function Breadcrumbs() {
  const breadcrumbs = useBreadcrumbs(); // Custom hook
  
  return (
    <nav className="flex items-center space-x-2 text-sm">
      {breadcrumbs.map((item, index) => (
        <React.Fragment key={index}>
          {item.path ? (
            <Link to={item.path}>{item.label}</Link>
          ) : (
            <span className="font-bold">{item.label}</span>
          )}
          {index < breadcrumbs.length - 1 && <span>/</span>}
        </React.Fragment>
      ))}
    </nav>
  );
}
```

---

## State Management

### Auth State (Zustand)
```typescript
// frontend/src/store/authStore.ts
interface AuthState {
  user: User | null;
  tenant: Tenant | null;
  isAuthenticated: boolean;
  login: (credentials: Credentials) => Promise<void>;
  logout: () => void;
  switchTenant: (tenantId: string) => void;
}

export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  tenant: null,
  isAuthenticated: false,
  
  login: async (credentials) => {
    const response = await authService.login(credentials);
    set({
      user: response.user,
      tenant: response.user.tenant,
      isAuthenticated: true,
    });
  },
  
  logout: () => {
    authService.logout();
    set({ user: null, tenant: null, isAuthenticated: false });
  },
  
  switchTenant: (tenantId) => {
    // Load tenant data and update state
  },
}));
```

---

## Business Logic

### Authentication Flow

**Login Flow:**
1. User enters credentials
2. POST `/api/v1/auth/login`
3. Receive JWT token
4. Store token in localStorage
5. Fetch user data (GET `/api/v1/auth/me`)
6. Update auth store
7. Redirect to dashboard or returnUrl

**Session Persistence:**
1. On app load, check localStorage for token
2. If token exists, verify with GET `/api/v1/auth/me`
3. If valid, restore auth state
4. If invalid, clear token and redirect to login

**Logout Flow:**
1. User clicks logout
2. Clear token from localStorage
3. Reset auth store
4. Redirect to `/login`

### Tenant Switching Logic
1. User selects tenant from dropdown
2. Update current tenant in store
3. Update URL with new tenantId
4. Refresh data for new tenant

---

## Testing Strategy

### Unit Tests

**Sidebar Component:**
- [ ] Renders all navigation items
- [ ] Highlights current active page
- [ ] Renders badges when provided
- [ ] Handles mobile toggle correctly

**Breadcrumbs Component:**
- [ ] Generates correct breadcrumb trail
- [ ] Renders clickable links for previous pages
- [ ] Renders non-clickable text for current page

**Auth Store:**
- [ ] Login updates state correctly
- [ ] Logout clears state
- [ ] Tenant switching updates state

### Integration Tests

**Protected Route:**
- [ ] Unauthenticated user redirected to login
- [ ] Authenticated user can access protected pages
- [ ] ReturnUrl works correctly

**Navigation Flow:**
- [ ] Click sidebar item navigates to correct page
- [ ] Active page highlighted
- [ ] Breadcrumbs update on navigation

### E2E Tests

**Full Auth Flow:**
1. Visit protected page â†’ Redirected to login
2. Login with valid credentials
3. Redirected to dashboard
4. Navigate via sidebar to assessments
5. Breadcrumbs show correct path
6. Logout
7. Redirected to login

---

## Implementation Notes

### Critical Considerations

**1. Tenant Context:**
- ã™ã¹ã¦ã®APIå‘¼ã³å‡ºã—ã«tenantIdã‚’å«ã‚ã‚‹
- URLã«`:tenantId`ã‚’å«ã‚ã‚‹ã“ã¨ã§ãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚³ãƒ¼ãƒ—ã‚’æ˜ç¢ºåŒ–
- ãƒ†ãƒŠãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆæ™‚ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥

**2. Route Protection:**
- `ProtectedRoute` wrapperã§JWTæ¤œè¨¼
- ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ã¯è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
- API 401ã‚¨ãƒ©ãƒ¼ã‚‚è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ

**3. Mobile Responsiveness:**
- Sidebarã¯`useMediaQuery`ã§ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®š
- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œï¼ˆARIAï¼‰

**4. Performance Optimization:**
- Layout componentã¯`React.memo`ã§æœ€é©åŒ–
- Sidebarã®å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’æœ€å°åŒ–
- Code splittingã§ãƒšãƒ¼ã‚¸åˆ¥ã«ãƒãƒ³ãƒ‰ãƒ«

---

## Related Specifications

- [Authentication](../../specs/auth/authentication.md)
- [Multi-Tenant Architecture](../../specs/auth/multi-tenant.md)
- [Assessment Features](./assessment-features.md)
- [Lead Management Features](./lead-management-features.md)

---

## Changelog

| Date | Version | Changes |
|------|---------|---------|
| 2025-11-11 | 1.0 | Initial specification |

---

**Status**: âœ… Ready for Review  
**Next Steps**: Review â†’ Approve â†’ Implement
