name: openspec-orchestrator
version: 2.0.0
description: |
  OpenSpecçµ±åˆã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼
  
  OpenSpecï¼ˆæ©Ÿèƒ½ä»•æ§˜ï¼‰ã¨OpenAPIï¼ˆAPIä»•æ§˜ï¼‰ã‚’é€£æºã•ã›ã€
  ä»•æ§˜é§†å‹•é–‹ç™ºã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«å…¨ä½“ã‚’è‡ªå‹•åŒ–ã—ã¾ã™ã€‚
  
  Proposal â†’ Review â†’ Approve â†’ Implement â†’ Archive â†’ Verify

activation:
  # OpenSpecä»•æ§˜å¤‰æ›´æ™‚
  file_patterns:
    - "openspec/**/*.md"
    - "openapi.json"
  
  # æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰
  commands:
    - "/openspec-status"      # ä»•æ§˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç¢ºèª
    - "/openspec-impact"      # å¤‰æ›´å½±éŸ¿ç¯„å›²ã®åˆ†æ
    - "/openspec-implement"   # ä»•æ§˜ã‹ã‚‰å®Ÿè£…éª¨çµ„ã¿ã‚’ç”Ÿæˆ
    - "/openspec-verify"      # å®Ÿè£…ãŒä»•æ§˜ã‚’æº€ãŸã™ã‹æ¤œè¨¼
    - "/openspec-report"      # å®Œå…¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

workflows:
  # 1. ä»•æ§˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
  status_check:
    description: OpenSpecä»•æ§˜ã®ç¾åœ¨çŠ¶æ…‹ã‚’å¯è¦–åŒ–
    steps:
      - name: "Spec Inventory"
        command: |
          echo "ğŸ“Š OpenSpec Inventory"
          echo "===================="
          echo ""
          echo "âœ… Approved Specs: $(find openspec/specs -name '*.md' -type f | wc -l)"
          echo "â³ Pending Changes: $(find openspec/changes -name '*.md' -type f 2>/dev/null | wc -l)"
          echo "ğŸ“¦ Archived: $(find openspec/archive -name '*.md' -type f 2>/dev/null | wc -l)"
          echo ""
          echo "ğŸ“‚ Specs by Category:"
          for dir in openspec/specs/*/; do
            if [ -d "$dir" ]; then
              category=$(basename "$dir")
              count=$(find "$dir" -name "*.md" -type f | wc -l)
              echo "  - $category: $count specs"
            fi
          done
        on_error: warn
      
      - name: "Implementation Coverage"
        command: |
          echo ""
          echo "ğŸ” Implementation Coverage Analysis"
          echo "===================================="
          
          # APIä»•æ§˜ã®å®Ÿè£…ã‚«ãƒãƒ¬ãƒƒã‚¸
          api_specs=$(find openspec/specs -path "*/api/*.md" 2>/dev/null | wc -l)
          api_endpoints=$(find backend/app/api -name "*.py" ! -name "__init__.py" | wc -l)
          echo "API Endpoints: $api_endpoints files for $api_specs specs"
          
          # æ©Ÿèƒ½ä»•æ§˜ã®å®Ÿè£…ã‚«ãƒãƒ¬ãƒƒã‚¸
          feature_specs=$(find openspec/specs/features -name "*.md" 2>/dev/null | wc -l)
          echo "Features: $feature_specs specs"
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè£…ã‚«ãƒãƒ¬ãƒƒã‚¸
          model_files=$(find backend/app/models -name "*.py" ! -name "__init__.py" | wc -l)
          echo "Data Models: $model_files implemented"
        on_error: warn

  # 2. å¤‰æ›´å½±éŸ¿ç¯„å›²åˆ†æ
  impact_analysis:
    description: ä»•æ§˜å¤‰æ›´ã®å½±éŸ¿ç¯„å›²ã‚’åˆ†æ
    steps:
      - name: "Detect Changed Specs"
        command: |
          echo "ğŸ” Detecting Changed Specifications"
          echo "===================================="
          
          # Gitå·®åˆ†ã‹ã‚‰å¤‰æ›´ã•ã‚ŒãŸä»•æ§˜ã‚’æŠ½å‡º
          changed_specs=$(git diff --name-only HEAD openspec/specs/ | grep "\.md$" || echo "")
          
          if [ -z "$changed_specs" ]; then
            echo "No specification changes detected."
            exit 0
          fi
          
          echo "Changed specs:"
          echo "$changed_specs"
          echo ""
          
          # å„ä»•æ§˜ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´å†…å®¹ã‚’åˆ†æ
          for spec in $changed_specs; do
            echo "Analyzing: $spec"
            
            # APIä»•æ§˜ã®å ´åˆã€é–¢é€£ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æ¤œç´¢
            if echo "$spec" | grep -q "api"; then
              echo "  â†’ API specification change detected"
              echo "  â†’ Affected: backend/app/api/"
              echo "  â†’ Action: Regenerate OpenAPI spec"
            fi
            
            # æ©Ÿèƒ½ä»•æ§˜ã®å ´åˆã€é–¢é€£ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æ¤œç´¢
            if echo "$spec" | grep -q "features"; then
              feature_name=$(basename "$spec" .md)
              echo "  â†’ Feature specification change: $feature_name"
              
              # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
              backend_files=$(grep -rl "$feature_name" backend/ --include="*.py" 2>/dev/null | head -5 || echo "")
              if [ -n "$backend_files" ]; then
                echo "  â†’ Backend files may need update:"
                echo "$backend_files" | sed 's/^/      /'
              fi
              
              # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
              frontend_files=$(grep -rl "$feature_name" frontend/src --include="*.tsx" --include="*.ts" 2>/dev/null | head -5 || echo "")
              if [ -n "$frontend_files" ]; then
                echo "  â†’ Frontend files may need update:"
                echo "$frontend_files" | sed 's/^/      /'
              fi
            fi
            echo ""
          done
        on_error: warn
      
      - name: "Suggest Actions"
        command: |
          echo "ğŸ’¡ Suggested Actions"
          echo "===================="
          echo ""
          echo "1. Review the changes in openspec/specs/"
          echo "2. Update related implementation files"
          echo "3. Regenerate OpenAPI spec: /openapiç”Ÿæˆ"
          echo "4. Run tests: /dev-check"
          echo "5. Update documentation if needed"
        on_error: ignore

  # 3. ä»•æ§˜ã‹ã‚‰å®Ÿè£…éª¨çµ„ã¿ç”Ÿæˆ
  scaffold_from_spec:
    description: OpenSpecä»•æ§˜ã‹ã‚‰å®Ÿè£…ã®éª¨çµ„ã¿ã‚’ç”Ÿæˆ
    steps:
      - name: "Parse Spec File"
        command: |
          echo "ğŸ—ï¸  Generating Implementation Scaffold"
          echo "======================================"
          echo ""
          echo "Note: This is a template generator."
          echo "Manual implementation is still required."
          echo ""
          
          # æœ€æ–°ã®å¤‰æ›´ææ¡ˆã‚’ç¢ºèª
          latest_change=$(find openspec/changes -name "*.md" -type f -printf '%T@ %p\n' 2>/dev/null | sort -rn | head -1 | cut -d' ' -f2-)
          
          if [ -n "$latest_change" ]; then
            echo "Latest change proposal: $latest_change"
            echo ""
            echo "Analyzing specification..."
            
            # ä»•æ§˜ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
            if grep -q "API" "$latest_change"; then
              echo "  â†’ API specification detected"
              echo "  â†’ Generate: backend/app/api/[endpoint].py"
              echo "  â†’ Template: .factory/templates/api_endpoint.py"
            fi
            
            if grep -q -i "model\|schema\|entity" "$latest_change"; then
              echo "  â†’ Data model specification detected"
              echo "  â†’ Generate: backend/app/models/[model].py"
              echo "  â†’ Template: .factory/templates/model.py"
            fi
            
            if grep -q -i "component\|ui\|frontend" "$latest_change"; then
              echo "  â†’ UI component specification detected"
              echo "  â†’ Generate: frontend/src/components/[Component].tsx"
              echo "  â†’ Template: .factory/templates/component.tsx"
            fi
          else
            echo "No pending changes found in openspec/changes/"
          fi
        on_error: warn

  # 4. å®Ÿè£…æ¤œè¨¼
  verify_implementation:
    description: å®Ÿè£…ãŒä»•æ§˜ã‚’æº€ãŸã™ã‹æ¤œè¨¼
    steps:
      - name: "Check Spec Coverage"
        command: |
          echo "âœ… Verifying Implementation Coverage"
          echo "===================================="
          echo ""
          
          # å„ã‚«ãƒ†ã‚´ãƒªã®ä»•æ§˜ã¨å®Ÿè£…ã‚’æ¯”è¼ƒ
          
          # 1. APIä»•æ§˜ã®æ¤œè¨¼
          echo "1. API Specifications"
          api_spec_count=$(find openspec/specs -path "*/api/*.md" 2>/dev/null | wc -l)
          api_impl_count=$(find backend/app/api -name "*.py" ! -name "__init__.py" | wc -l)
          echo "   Specs: $api_spec_count | Implementations: $api_impl_count"
          
          # 2. æ©Ÿèƒ½ä»•æ§˜ã®æ¤œè¨¼
          echo "2. Feature Specifications"
          feature_spec_count=$(find openspec/specs/features -name "*.md" 2>/dev/null | wc -l)
          echo "   Specs: $feature_spec_count"
          
          # 3. èªè¨¼ä»•æ§˜ã®æ¤œè¨¼
          echo "3. Auth Specifications"
          auth_spec_count=$(find openspec/specs/auth -name "*.md" 2>/dev/null | wc -l)
          echo "   Specs: $auth_spec_count"
          
          echo ""
          echo "Run /dev-check for detailed validation"
        on_error: warn
      
      - name: "Check OpenAPI Sync"
        command: |
          echo ""
          echo "ğŸ“„ OpenAPI Specification Sync"
          echo "=============================="
          
          if [ -f "openapi.json" ]; then
            spec_mtime=$(stat -c %Y openapi.json 2>/dev/null || stat -f %m openapi.json 2>/dev/null)
            backend_mtime=$(find backend/app/api -name "*.py" -type f -printf '%T@\n' 2>/dev/null | sort -rn | head -1 | cut -d. -f1)
            
            if [ "$backend_mtime" -gt "$spec_mtime" ]; then
              echo "âš ï¸  WARNING: Backend code is newer than OpenAPI spec"
              echo "    Run: /openapiç”Ÿæˆ"
            else
              echo "âœ… OpenAPI spec is up to date"
            fi
          else
            echo "âš ï¸  WARNING: openapi.json not found"
            echo "    Run: cd backend && python scripts/generate_openapi.py"
          fi
        on_error: warn

  # 5. å®Œå…¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  full_report:
    description: OpenSpecçµ±åˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
    steps:
      - name: "Generate Comprehensive Report"
        command: |
          cat << 'EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘       OpenSpec Integration Report                  â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“Š SPECIFICATION INVENTORY
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          EOF
          
          approved=$(find openspec/specs -name "*.md" -type f | wc -l)
          pending=$(find openspec/changes -name "*.md" -type f 2>/dev/null | wc -l)
          archived=$(find openspec/archive -name "*.md" -type f 2>/dev/null | wc -l)
          
          echo "  Approved Specifications: $approved"
          echo "  Pending Changes: $pending"
          echo "  Archived Changes: $archived"
          echo ""
          
          cat << 'EOF'
          ğŸ” IMPLEMENTATION STATUS
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          EOF
          
          api_endpoints=$(find backend/app/api -name "*.py" ! -name "__init__.py" | wc -l)
          models=$(find backend/app/models -name "*.py" ! -name "__init__.py" | wc -l)
          services=$(find backend/app/services -name "*.py" ! -name "__init__.py" | wc -l)
          components=$(find frontend/src -name "*.tsx" -type f | wc -l)
          
          echo "  Backend API Endpoints: $api_endpoints"
          echo "  Data Models: $models"
          echo "  Services: $services"
          echo "  Frontend Components: $components"
          echo ""
          
          cat << 'EOF'
          ğŸ“‚ SPECIFICATION CATEGORIES
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          EOF
          
          for dir in openspec/specs/*/; do
            if [ -d "$dir" ]; then
              category=$(basename "$dir")
              count=$(find "$dir" -name "*.md" -type f | wc -l)
              if [ $count -gt 0 ]; then
                printf "  %-20s : %2d specs\n" "$category" "$count"
              fi
            fi
          done
          echo ""
          
          cat << 'EOF'
          ğŸ¯ NEXT ACTIONS
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          EOF
          
          if [ $pending -gt 0 ]; then
            echo "  â†’ Review $pending pending change(s) in openspec/changes/"
          fi
          
          if [ -f "openapi.json" ]; then
            backend_newer=$(find backend/app/api -name "*.py" -type f -newer openapi.json | wc -l)
            if [ $backend_newer -gt 0 ]; then
              echo "  â†’ Regenerate OpenAPI spec (backend code has changed)"
            fi
          fi
          
          echo "  â†’ Run /dev-check for quality validation"
          echo "  â†’ Run /openspec-verify for detailed coverage"
          echo ""
        on_error: ignore

# çµ±åˆæ©Ÿèƒ½
integration:
  # OpenSpec â†’ OpenAPI é€£æº
  openspec_to_openapi:
    enabled: true
    trigger: "on_spec_approval"
    action: "suggest_openapi_update"
  
  # å®Ÿè£…æ¤œè¨¼
  verification:
    enabled: true
    on_commit: false
    on_pr: true
  
  # ãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆ
  reporting:
    enabled: true
    schedule: "weekly"
    format: "markdown"

# é€šçŸ¥è¨­å®š
notifications:
  on_spec_change:
    enabled: true
    message: |
      ğŸ“ OpenSpec Change Detected
      
      A specification has been modified.
      Run /openspec-impact to analyze the impact.
  
  on_pending_changes:
    enabled: true
    threshold: 3  # 3ã¤ä»¥ä¸Šã®æœªæ‰¿èªå¤‰æ›´ã§é€šçŸ¥
    message: |
      âš ï¸  Multiple Pending Specifications
      
      There are {count} pending changes awaiting review.
      Consider reviewing and approving them.

# ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
best_practices:
  - rule: "Spec Before Code"
    description: "å®Ÿè£…å‰ã«å¿…ãšä»•æ§˜ã‚’æ‰¿èªã™ã‚‹"
    enforcement: "recommend"
  
  - rule: "Spec-Implementation Sync"
    description: "ä»•æ§˜ã¨å®Ÿè£…ã‚’å¸¸ã«åŒæœŸã•ã›ã‚‹"
    enforcement: "error"
  
  - rule: "OpenSpec + OpenAPI"
    description: "æ©Ÿèƒ½ä»•æ§˜ï¼ˆOpenSpecï¼‰ã¨APIä»•æ§˜ï¼ˆOpenAPIï¼‰ã‚’ä¸¡æ–¹ç¶­æŒ"
    enforcement: "recommend"
  
  - rule: "Regular Verification"
    description: "å®šæœŸçš„ã« /openspec-verify ã‚’å®Ÿè¡Œ"
    enforcement: "recommend"

# ãƒ˜ãƒ«ãƒ—
help:
  commands:
    - command: "/openspec-status"
      description: "ä»•æ§˜ã®ç¾åœ¨çŠ¶æ…‹ã¨çµ±è¨ˆã‚’è¡¨ç¤º"
    
    - command: "/openspec-impact"
      description: "ä»•æ§˜å¤‰æ›´ã®å½±éŸ¿ç¯„å›²ã‚’åˆ†æ"
    
    - command: "/openspec-implement"
      description: "ä»•æ§˜ã‹ã‚‰å®Ÿè£…ã®éª¨çµ„ã¿ã‚’ç”Ÿæˆ"
    
    - command: "/openspec-verify"
      description: "å®Ÿè£…ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æ¤œè¨¼"
    
    - command: "/openspec-report"
      description: "çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ"
  
  quick_start: |
    # OpenSpec Orchestrator Quick Start
    
    1. ä»•æ§˜ã®çŠ¶æ…‹ã‚’ç¢ºèª:
       /openspec-status
    
    2. æ–°æ©Ÿèƒ½ã‚’ææ¡ˆ:
       - openspec/changes/ ã«ä»•æ§˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
       - ãƒãƒ¼ãƒ ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼
    
    3. æ‰¿èªå¾Œã«å®Ÿè£…:
       - ä»•æ§˜ã‚’ openspec/specs/ ã«ç§»å‹•
       - /openspec-implement ã§éª¨çµ„ã¿ç”Ÿæˆ
       - å®Ÿè£…ã‚’å®Œæˆ
    
    4. æ¤œè¨¼:
       /openspec-verify
       /dev-check
    
    5. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–:
       - å®Œäº†ã—ãŸä»•æ§˜ã‚’ openspec/archive/ ã«ç§»å‹•
