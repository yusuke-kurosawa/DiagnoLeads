# OpenSpecä»•æ§˜åŒæœŸDroid
# ä»•æ§˜ã¨å®Ÿè£…ã®æ•´åˆæ€§ã‚’ç¶­æŒ

name: openspec-sync
description: "OpenSpecä»•æ§˜ã¨å®Ÿè£…ã®åŒæœŸã‚’ç®¡ç†ã—ã€ä»•æ§˜é§†å‹•é–‹ç™ºã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹Droid"
version: "1.0.0"

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶
triggers:
  - on_command: "/spec-check"
  - on_command: "/spec-sync"
  - on_pr_create: true
  - on_code_change:
      paths:
        - "openspec/**/*.md"
        - "backend/app/**/*.py"
        - "frontend/src/**/*.{ts,tsx}"

# å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—
steps:
  # 1. ä»•æ§˜ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
  - name: "Specification Validation"
    description: "OpenSpecä»•æ§˜ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ã‚’ç¢ºèª"
    steps:
      - name: "Check Spec Structure"
        run: |
          echo "ğŸ” Validating OpenSpec structure..."
          
          # å¿…é ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
          required_dirs=("openspec/specs" "openspec/changes" "openspec/archive")
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "âŒ ERROR: Missing required directory: $dir"
              exit 1
            fi
          done
          
          echo "âœ… OpenSpec directory structure is valid"
        fail_on_error: true
        
      - name: "Validate Spec Files"
        run: |
          echo "ğŸ” Validating spec file format..."
          
          # specs/é…ä¸‹ã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼
          spec_files=$(find openspec/specs -name "*.md" -type f)
          
          for file in $spec_files; do
            echo "Checking: $file"
            
            # å¿…é ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç¢ºèª
            if ! grep -q "^# " "$file"; then
              echo "âš ï¸  WARNING: $file missing main title"
            fi
            
            # ç©ºãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
            if [ ! -s "$file" ]; then
              echo "âš ï¸  WARNING: $file is empty"
            fi
          done
          
          echo "âœ… Spec files validated"
        fail_on_error: false

  # 2. ä»•æ§˜ã¨å®Ÿè£…ã®åŒæœŸãƒã‚§ãƒƒã‚¯
  - name: "Spec-Implementation Sync Check"
    description: "ä»•æ§˜ã«å¯¾å¿œã™ã‚‹å®Ÿè£…ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª"
    steps:
      - name: "Check API Endpoints"
        run: |
          echo "ğŸ” Checking API endpoints against spec..."
          
          # APIä»•æ§˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          api_specs=$(find openspec/specs -path "*/api/*.md" -o -name "*api*.md" 2>/dev/null)
          
          if [ -n "$api_specs" ]; then
            echo "Found API specifications:"
            echo "$api_specs"
            
            # å®Ÿè£…æ¸ˆã¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡º
            implemented_endpoints=$(grep -rh "@router\." backend/app/api/ | grep -oE "/(get|post|put|delete|patch)" | sort -u)
            
            echo ""
            echo "Implemented endpoints:"
            echo "$implemented_endpoints"
          else
            echo "INFO: No API specification files found in openspec/specs"
          fi
        fail_on_error: false
        
      - name: "Check Data Models"
        run: |
          echo "ğŸ” Checking data models against spec..."
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ä»•æ§˜ã®ç¢ºèª
          model_specs=$(find openspec/specs -name "*model*.md" -o -name "*schema*.md" 2>/dev/null)
          
          if [ -n "$model_specs" ]; then
            echo "Found model specifications:"
            echo "$model_specs"
            
            # å®Ÿè£…æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’æŠ½å‡º
            implemented_models=$(find backend/app/models -name "*.py" -type f ! -name "__init__.py" -exec basename {} .py \;)
            
            echo ""
            echo "Implemented models:"
            echo "$implemented_models"
          else
            echo "INFO: No model specification files found"
          fi
        fail_on_error: false
        
      - name: "Check Frontend Components"
        run: |
          echo "ğŸ” Checking frontend components against spec..."
          
          # UIä»•æ§˜ã®ç¢ºèª
          ui_specs=$(find openspec/specs -name "*ui*.md" -o -name "*component*.md" -o -name "*frontend*.md" 2>/dev/null)
          
          if [ -n "$ui_specs" ]; then
            echo "Found UI specifications:"
            echo "$ui_specs"
            
            # å®Ÿè£…æ¸ˆã¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æŠ½å‡º
            implemented_components=$(find frontend/src -name "*.tsx" -type f | wc -l)
            
            echo ""
            echo "Implemented React components: $implemented_components"
          else
            echo "INFO: No UI specification files found"
          fi
        fail_on_error: false

  # 3. å¤‰æ›´ææ¡ˆã®è¿½è·¡
  - name: "Track Specification Changes"
    description: "openspec/changes/ ã®å¤‰æ›´ææ¡ˆã‚’è¿½è·¡"
    steps:
      - name: "List Pending Changes"
        run: |
          echo "ğŸ” Checking for pending specification changes..."
          
          pending_changes=$(find openspec/changes -name "*.md" -type f 2>/dev/null)
          
          if [ -n "$pending_changes" ]; then
            echo "âš ï¸  Pending specification changes found:"
            echo "$pending_changes"
            echo ""
            echo "These changes are awaiting review and approval."
            echo "Once approved, move them to openspec/specs/"
          else
            echo "âœ… No pending specification changes"
          fi
        fail_on_error: false
        
      - name: "Check for Outdated Changes"
        run: |
          echo "ğŸ” Checking for outdated change proposals..."
          
          # 30æ—¥ä»¥ä¸Šå‰ã®å¤‰æ›´ææ¡ˆã‚’ãƒã‚§ãƒƒã‚¯
          if [ -d "openspec/changes" ]; then
            old_changes=$(find openspec/changes -name "*.md" -type f -mtime +30 2>/dev/null)
            
            if [ -n "$old_changes" ]; then
              echo "âš ï¸  WARNING: The following change proposals are over 30 days old:"
              echo "$old_changes"
              echo ""
              echo "Consider reviewing and either approving or archiving them."
            fi
          fi
        fail_on_error: false

  # 4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒæœŸ
  - name: "Documentation Sync"
    description: "ä»•æ§˜ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®åŒæœŸã‚’ç¢ºèª"
    steps:
      - name: "Check Documentation Links"
        run: |
          echo "ğŸ” Checking documentation references..."
          
          # README.mdãŒopenspec/specs/ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã‹ç¢ºèª
          if grep -q "openspec/specs" README.md; then
            echo "âœ… README.md references OpenSpec specs"
          else
            echo "âš ï¸  INFO: README.md doesn't reference OpenSpec specs"
            echo "   Consider adding links to specification files"
          fi
          
          # CLAUDE.mdãŒOpenSpecãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å«ã‚€ã‹ç¢ºèª
          if grep -q "openspec" CLAUDE.md; then
            echo "âœ… CLAUDE.md includes OpenSpec workflow"
          else
            echo "âš ï¸  INFO: CLAUDE.md missing OpenSpec workflow reference"
          fi
        fail_on_error: false
        
      - name: "Generate Spec Summary"
        run: |
          echo "ğŸ” Generating specification summary..."
          
          echo ""
          echo "================================"
          echo "OpenSpec Specification Summary"
          echo "================================"
          echo ""
          
          # æ‰¿èªæ¸ˆã¿ä»•æ§˜ã®æ•°
          approved_specs=$(find openspec/specs -name "*.md" -type f | wc -l)
          echo "Approved specifications: $approved_specs"
          
          # å¤‰æ›´ææ¡ˆã®æ•°
          pending_changes=$(find openspec/changes -name "*.md" -type f 2>/dev/null | wc -l)
          echo "Pending changes: $pending_changes"
          
          # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®æ•°
          archived_changes=$(find openspec/archive -name "*.md" -type f 2>/dev/null | wc -l)
          echo "Archived changes: $archived_changes"
          
          echo ""
          
          # ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®ä»•æ§˜æ•°
          if [ -d "openspec/specs" ]; then
            echo "Specifications by category:"
            for dir in openspec/specs/*/; do
              if [ -d "$dir" ]; then
                category=$(basename "$dir")
                count=$(find "$dir" -name "*.md" -type f | wc -l)
                if [ $count -gt 0 ]; then
                  echo "  - $category: $count"
                fi
              fi
            done
          fi
        fail_on_error: false

  # 5. OpenSpecãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¬ã‚¤ãƒ‰
  - name: "Workflow Guidance"
    description: "OpenSpecä½¿ç”¨ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º"
    condition: "when: command == '/spec-help'"
    steps:
      - name: "Show OpenSpec Workflow"
        run: |
          echo "================================"
          echo "OpenSpec Workflow Guide"
          echo "================================"
          echo ""
          echo "ğŸ“ **Step 1: Propose a Change**"
          echo "   Create a new spec file in openspec/changes/"
          echo "   or use: /openspec-proposal \"feature description\""
          echo ""
          echo "ğŸ‘€ **Step 2: Review**"
          echo "   Team reviews the specification"
          echo "   Discuss and refine the proposal"
          echo ""
          echo "âœ… **Step 3: Approve**"
          echo "   Move approved spec to openspec/specs/"
          echo "   This becomes the source of truth"
          echo ""
          echo "ğŸ’» **Step 4: Implement**"
          echo "   Implement based on approved specification"
          echo "   Use: /openspec-apply"
          echo ""
          echo "ğŸ“¦ **Step 5: Archive**"
          echo "   After implementation, archive the change"
          echo "   Use: /openspec-archive"
          echo ""
          echo "ğŸ”„ **Continuous Sync**"
          echo "   Run /spec-check regularly to ensure sync"
          echo "   between specifications and implementation"
          echo ""

# ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚³ãƒãƒ³ãƒ‰
commands:
  - name: "spec-check"
    description: "ä»•æ§˜ã¨å®Ÿè£…ã®åŒæœŸçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯"
    
  - name: "spec-sync"
    description: "ä»•æ§˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æã—ã€å®Ÿè£…çŠ¶æ³ã‚’ãƒ¬ãƒãƒ¼ãƒˆ"
    
  - name: "spec-help"
    description: "OpenSpecãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º"

# æˆåŠŸæ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
on_success:
  - action: "comment"
    message: |
      âœ… **OpenSpec Sync Check Passed!**
      
      - Specification structure: âœ“
      - Spec-implementation sync: âœ“
      - Documentation references: âœ“
      
      **Quick Links:**
      - [Approved Specs](./openspec/specs/)
      - [Pending Changes](./openspec/changes/)
      - [Workflow Guide](./openspec/README.md)

  - action: "label"
    labels: ["spec-compliant"]

# è­¦å‘Šæ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
on_warning:
  - action: "comment"
    message: |
      âš ï¸  **OpenSpec Sync Warnings**
      
      Some specification-related issues were detected:
      - Check pending changes in `openspec/changes/`
      - Verify spec-implementation alignment
      - Review outdated change proposals
      
      Run `/spec-sync` for detailed analysis.

  - action: "label"
    labels: ["spec-review-suggested"]

# è¨­å®š
config:
  timeout: 180  # 3åˆ†
  retry_on_failure: false
  
  # OpenSpecè¨­å®š
  openspec:
    specs_dir: "./openspec/specs"
    changes_dir: "./openspec/changes"
    archive_dir: "./openspec/archive"
    
  # é€šçŸ¥è¨­å®š
  notifications:
    on_pending_changes: true
    on_outdated_proposals: true
    on_missing_implementation: false  # æƒ…å ±æä¾›ã®ã¿
