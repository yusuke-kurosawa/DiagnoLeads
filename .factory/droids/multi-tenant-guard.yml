# ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚¬ãƒ¼ãƒ‰Droid
# ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢é•åã‚’è‡ªå‹•æ¤œå‡ºãƒ»é˜²æ­¢

name: multi-tenant-guard
description: "ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿åˆ†é›¢é•åã‚’æ¤œå‡ºã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’é˜²æ­¢ã™ã‚‹Droid"
version: "1.0.0"
priority: critical

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶
triggers:
  - on_command: "/tenant-check"
  - on_pr_create: true
  - on_code_change:
      paths:
        - "backend/app/models/**/*.py"
        - "backend/app/api/**/*.py"
        - "backend/app/services/**/*.py"
        - "backend/alembic/versions/**/*.py"

# å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—
steps:
  # 1. ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œè¨¼
  - name: "Code Pattern Validation"
    description: "ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢é•åãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º"
    steps:
      - name: "Detect Missing Tenant Filter"
        run: |
          echo "ğŸ” Checking for missing tenant_id filters in queries..."
          
          # SQLAlchemyã‚¯ã‚¨ãƒªã§tenant_idãƒ•ã‚£ãƒ«ã‚¿ãŒæ¬ ã‘ã¦ã„ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
          violations=0
          
          # .all(), .first(), .count() ãªã©ã®å¾Œã«filter(tenant_id)ãŒãªã„ãƒ‘ã‚¿ãƒ¼ãƒ³
          if grep -rn "\.query(" backend/app/ | grep -v "filter.*tenant_id" | grep -E "\.(all|first|count|one|scalar)\(\)"; then
            echo "âŒ ERROR: Found queries without tenant_id filter!"
            violations=$((violations + 1))
          fi
          
          # db.execute() ã®ç›´æ¥ä½¿ç”¨ï¼ˆç”ŸSQLã®å¯èƒ½æ€§ï¼‰
          if grep -rn "db\.execute\|session\.execute" backend/app/api backend/app/services | grep -v "tenant_id"; then
            echo "âš ï¸  WARNING: Direct SQL execution detected. Verify tenant_id filtering."
          fi
          
          if [ $violations -gt 0 ]; then
            exit 1
          fi
        fail_on_error: true
        
      - name: "Check Model Definitions"
        run: |
          echo "ğŸ” Checking model definitions for tenant_id column..."
          
          # modelsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã§tenant_idã‚«ãƒ©ãƒ ã‚’ç¢ºèª
          for file in backend/app/models/*.py; do
            if [ "$file" != "backend/app/models/__init__.py" ]; then
              if ! grep -q "tenant_id" "$file"; then
                filename=$(basename "$file")
                # ãƒ†ãƒŠãƒ³ãƒˆä¸è¦ãªãƒ¢ãƒ‡ãƒ«ï¼ˆUser, Tenantãªã©ï¼‰ã‚’é™¤å¤–
                if [[ ! "$filename" =~ ^(user|tenant|__) ]]; then
                  echo "âš ï¸  WARNING: $file may be missing tenant_id column"
                fi
              fi
            fi
          done
        fail_on_error: false
        
      - name: "Check API Endpoint Security"
        run: |
          echo "ğŸ” Checking API endpoints for tenant validation..."
          
          # ãƒ†ãƒŠãƒ³ãƒˆIDã‚’å«ã‚€ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèª
          if grep -rn "@router\." backend/app/api/ | grep -v "/tenants/{tenant_id}"; then
            echo "âš ï¸  INFO: Some endpoints don't include tenant_id in path"
            echo "       Ensure tenant validation is done via JWT or other means"
          fi
          
          # current_tenant ã‚„ get_current_tenant ã®ä½¿ç”¨ã‚’ç¢ºèª
          api_files=$(find backend/app/api -name "*.py" -type f)
          for file in $api_files; do
            if grep -q "@router\." "$file"; then
              if ! grep -q "current_tenant\|get_current_tenant\|Depends.*tenant" "$file"; then
                echo "âš ï¸  WARNING: $file may be missing tenant validation"
              fi
            fi
          done
        fail_on_error: false

  # 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼
  - name: "Database Schema Validation"
    description: "ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¹ã‚­ãƒ¼ãƒã‚’æ¤œè¨¼"
    steps:
      - name: "Check Migration Files"
        run: |
          echo "ğŸ” Checking Alembic migration files..."
          
          # æœ€æ–°ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          latest_migration=$(ls -t backend/alembic/versions/*.py 2>/dev/null | head -1)
          
          if [ -n "$latest_migration" ]; then
            echo "Latest migration: $latest_migration"
            
            # æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆæ™‚ã«tenant_idã‚«ãƒ©ãƒ ãŒã‚ã‚‹ã‹ç¢ºèª
            if grep -q "create_table" "$latest_migration"; then
              if ! grep -q "tenant_id" "$latest_migration"; then
                echo "âš ï¸  WARNING: New table may be missing tenant_id column"
              fi
            fi
            
            # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«tenant_idãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if grep -q "create_index" "$latest_migration"; then
              if ! grep -q "tenant_id" "$latest_migration"; then
                echo "âš ï¸  INFO: Consider adding tenant_id to indexes for performance"
              fi
            fi
          fi
        fail_on_error: false
        
      - name: "Verify Row-Level Security"
        run: |
          echo "ğŸ” Checking for Row-Level Security policies..."
          
          # RLSãƒãƒªã‚·ãƒ¼è¨­å®šã®ãƒã‚§ãƒƒã‚¯ï¼ˆPostgreSQLï¼‰
          if find backend/alembic/versions -name "*.py" -exec grep -l "CREATE POLICY\|ALTER TABLE.*ENABLE ROW LEVEL SECURITY" {} \;; then
            echo "âœ… RLS policies found"
          else
            echo "âš ï¸  INFO: Consider implementing Row-Level Security in PostgreSQL"
            echo "       https://supabase.com/docs/guides/auth/row-level-security"
          fi
        fail_on_error: false

  # 3. ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰æ¤œè¨¼
  - name: "Test Coverage Validation"
    description: "ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèª"
    working_directory: "./backend"
    steps:
      - name: "Check Multi-Tenant Tests"
        run: |
          echo "ğŸ” Checking for multi-tenant test cases..."
          
          # ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ãƒ†ã‚¹ãƒˆã®å­˜åœ¨ç¢ºèª
          if ! find tests -name "*.py" -exec grep -l "tenant" {} \;; then
            echo "âŒ ERROR: No tenant-related tests found!"
            echo "   Please add tests for tenant data isolation"
            exit 1
          fi
          
          # ã‚¯ãƒ­ã‚¹ãƒ†ãƒŠãƒ³ãƒˆã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆã®ç¢ºèª
          if find tests -name "*.py" -exec grep -l "cross.*tenant\|tenant.*isolation" {} \;; then
            echo "âœ… Cross-tenant access tests found"
          else
            echo "âš ï¸  WARNING: Consider adding cross-tenant access prevention tests"
          fi
        fail_on_error: true

  # 4. ãƒ©ãƒ³ã‚¿ã‚¤ãƒ æ¤œè¨¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  - name: "Runtime Validation"
    description: "é–‹ç™ºç’°å¢ƒã§ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãƒã‚§ãƒƒã‚¯"
    condition: "when: env.ENVIRONMENT == 'development'"
    steps:
      - name: "Database Integrity Check"
        working_directory: "./backend"
        run: |
          echo "ğŸ” Running database integrity checks..."
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãŒå¯èƒ½ãªå ´åˆã®ã¿å®Ÿè¡Œ
          if [ -n "$DATABASE_URL" ]; then
            source venv/bin/activate
            
            # å­¤ç«‹ãƒ‡ãƒ¼ã‚¿ï¼ˆtenant_id = NULLï¼‰ã®ãƒã‚§ãƒƒã‚¯
            python3 << 'EOF'
import os
from sqlalchemy import create_engine, text

db_url = os.getenv('DATABASE_URL')
if db_url:
    engine = create_engine(db_url)
    with engine.connect() as conn:
        # å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®tenant_id NULL ãƒã‚§ãƒƒã‚¯
        tables = ['assessments', 'questions', 'leads']
        for table in tables:
            try:
                result = conn.execute(
                    text(f"SELECT COUNT(*) FROM {table} WHERE tenant_id IS NULL")
                )
                null_count = result.scalar()
                if null_count > 0:
                    print(f"âš ï¸  WARNING: {table} has {null_count} rows with NULL tenant_id")
            except Exception as e:
                print(f"INFO: Could not check {table}: {e}")
EOF
          else
            echo "INFO: DATABASE_URL not set, skipping database checks"
          fi
        fail_on_error: false

  # 5. ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  - name: "Generate Security Report"
    steps:
      - name: "Summary"
        run: |
          echo "================================"
          echo "Multi-Tenant Security Check Summary"
          echo "================================"
          echo ""
          echo "âœ… Code Pattern Validation"
          echo "âœ… Database Schema Validation"
          echo "âœ… Test Coverage Validation"
          echo ""
          echo "All tenant isolation checks passed!"

# ãƒ«ãƒ¼ãƒ«å®šç¾©
rules:
  # ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³
  forbidden_patterns:
    - pattern: "\.query\(.*\)\.all\(\)"
      message: "Missing tenant_id filter on .all() query"
      severity: error
      exclude:
        - "backend/app/core/admin.py"  # ç®¡ç†è€…ç”¨ã¯é™¤å¤–
    
    - pattern: "\.query\(.*\)\.filter\([^)]*\)\.(?!.*tenant_id)"
      message: "Query filter missing tenant_id"
      severity: error
    
    - pattern: "DELETE FROM .* WHERE (?!.*tenant_id)"
      message: "DELETE statement missing tenant_id condition"
      severity: critical
    
    - pattern: "UPDATE .* SET .* WHERE (?!.*tenant_id)"
      message: "UPDATE statement missing tenant_id condition"
      severity: critical
  
  # æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³
  recommended_patterns:
    - pattern: "def .*tenant.*"
      message: "Good: Function name includes 'tenant'"
      severity: info
    
    - pattern: "filter.*tenant_id.*=="
      message: "Good: Proper tenant_id filtering"
      severity: info

# æˆåŠŸæ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
on_success:
  - action: "comment"
    message: |
      âœ… **Multi-Tenant Security Check Passed!**
      
      - Code patterns: âœ“
      - Database schema: âœ“
      - Test coverage: âœ“
      
      Tenant data isolation is properly implemented.

  - action: "label"
    labels: ["security-approved", "tenant-safe"]

# å¤±æ•—æ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
on_failure:
  - action: "comment"
    message: |
      âŒ **Multi-Tenant Security Issues Detected!**
      
      **CRITICAL**: This PR may have tenant data isolation violations.
      
      **Common Issues:**
      1. Database queries without `tenant_id` filter
      2. Missing tenant validation in API endpoints
      3. Insufficient test coverage for tenant isolation
      
      **How to Fix:**
      ```python
      # âŒ BAD: No tenant filter
      assessments = db.query(Assessment).all()
      
      # âœ… GOOD: With tenant filter
      assessments = db.query(Assessment).filter(
          Assessment.tenant_id == current_tenant.id
      ).all()
      ```
      
      **Required Actions:**
      - Review all database queries
      - Add tenant_id filtering
      - Add cross-tenant access prevention tests
      - Run `/tenant-check` again
      
      **Reference:** `.factory/context.md` - Multi-Tenant Architecture

  - action: "label"
    labels: ["security-review-required", "tenant-violation"]
  
  - action: "block_merge"
    reason: "Multi-tenant security violations must be fixed before merging"

# è¨­å®š
config:
  timeout: 300  # 5åˆ†
  required_for_merge: true  # ãƒãƒ¼ã‚¸å‰ã«å¿…é ˆ
  auto_fix: false  # è‡ªå‹•ä¿®æ­£ã¯è¡Œã‚ãªã„ï¼ˆæ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…é ˆï¼‰
  
  # ç’°å¢ƒå¤‰æ•°
  env:
    PYTHONPATH: "./backend"
