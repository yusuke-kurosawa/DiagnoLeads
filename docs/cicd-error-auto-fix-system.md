# GitHub Actions エラー自動改修システム

## 概要

このドキュメントでは、GitHub Actionsのエラーを自動的に検出・解析・修正するシステムについて説明します。

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│ GitHub Actions CI/CD Pipeline                                │
│  ├─ Backend Tests (pytest, ruff, mypy)                      │
│  ├─ Frontend Tests (lint, type-check, build)                │
│  └─ Docker Build                                             │
└─────────────────────────────────────────────────────────────┘
                        │
                    ❌ 失敗
                        │
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ エラーログキャプチャ                                          │
│  ├─ pytest-errors.log                                        │
│  ├─ ruff-errors.log                                          │
│  ├─ mypy-errors.log                                          │
│  ├─ lint-errors.log                                          │
│  ├─ typescript-errors.log                                    │
│  ├─ build-errors.log                                         │
│  └─ metadata.txt                                             │
└─────────────────────────────────────────────────────────────┘
                        │
                        ↓
┌─────────────────────────────────────────────────────────────┐
│ 3つの改修アプローチ                                           │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 1. PR自動コメント                                     │  │
│  │    - エラーログを解析                                │  │
│  │    - PRにコメントで詳細を投稿                        │  │
│  │    - Claude Codeがコメントを読んで修正               │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 2. ローカル解析スクリプト                             │  │
│  │    - CLIツールでエラーログをダウンロード             │  │
│  │    - Claude Codeで解析                               │  │
│  │    - 修正提案または自動修正                           │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 3. 自動修正ワークフロー                               │  │
│  │    - エラーパターンを認識                             │  │
│  │    - 自動修正を試みる                                 │  │
│  │    - 修正コミット & 再テスト                          │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## アプローチ1: PR自動コメント

### 仕組み

1. CI/CDが失敗したらエラーログをアーティファクトに保存
2. 別のワークフローでエラーログをダウンロード
3. エラーを解析してフォーマット
4. PRに詳細なコメントを投稿
5. Claude CodeがPRコメントを読んで修正

### 実装ファイル

- `.github/workflows/comment-on-failure.yml` - PRコメントワークフロー

### メリット

- ✅ エラー内容がPR上で一目瞭然
- ✅ Claude CodeがGitHub UIから直接確認可能
- ✅ チーム全員が見られる
- ✅ 履歴が残る

### デメリット

- ⚠️ GitHub Actionsの実行回数が増える
- ⚠️ コメントが多くなりすぎる可能性

## アプローチ2: ローカル解析スクリプト

### 仕組み

1. CI/CDが失敗したらエラーログをアーティファクトに保存
2. ローカルでCLIツールを実行
3. GitHub APIでアーティファクトをダウンロード
4. エラーを解析してClaude Codeで読みやすく整形
5. Claude Codeで修正

### 実装ファイル

- `scripts/analyze-cicd-errors.sh` - エラーログダウンロード・解析スクリプト
- `.claude/commands/fix-cicd.md` - Claude Codeスラッシュコマンド

### メリット

- ✅ 完全にローカルで制御できる
- ✅ Claude Codeで直接解析・修正
- ✅ GitHub Actionsのコスト削減
- ✅ オンデマンドで実行

### デメリット

- ⚠️ 手動実行が必要
- ⚠️ GitHub CLIのセットアップが必要

## アプローチ3: 自動修正ワークフロー

### 仕組み

1. CI/CDが失敗したらエラーログを解析
2. エラーパターンを認識（例: import missing, type error）
3. 既知のエラーパターンに対して自動修正を試みる
4. 修正をコミット
5. CI/CDを再実行

### 実装ファイル

- `.github/workflows/auto-fix-errors.yml` - 自動修正ワークフロー
- `scripts/auto-fix-common-errors.py` - エラー修正スクリプト

### メリット

- ✅ 完全自動化
- ✅ 既知のエラーは即座に修正
- ✅ 人間の介入不要

### デメリット

- ⚠️ 複雑なエラーには対応不可
- ⚠️ 誤った修正のリスク
- ⚠️ 無限ループの可能性

## 推奨アプローチ

**段階的実装:**

### Phase 1 (即座)
- ✅ **アプローチ2: ローカル解析スクリプト** を実装
  - 最もシンプルで安全
  - Claude Codeで柔軟に対応可能
  - すぐに使える

### Phase 2 (1週間後)
- ✅ **アプローチ1: PR自動コメント** を追加
  - チーム全体で共有
  - Claude Codeでの修正が楽になる

### Phase 3 (1ヶ月後)
- ✅ **アプローチ3: 自動修正** を一部導入
  - 既知のエラーパターンのみ
  - セーフガード付き（最大3回まで）

## エラーパターン分類

### 自動修正可能なエラー

1. **Import Missing**
   ```
   ModuleNotFoundError: No module named 'xxx'
   → requirements.txt に追加
   ```

2. **Linter Errors (自動修正可能)**
   ```
   ruff check --fix .
   ruff format .
   ```

3. **Type Errors (簡単なもの)**
   ```
   error: Incompatible types in assignment
   → 型ヒントを追加
   ```

### Claude Code解析が必要なエラー

1. **ロジックエラー**
2. **複雑な型エラー**
3. **テスト失敗**
4. **ビルドエラー**

## 使い方

### ローカル解析スクリプト

```bash
# エラーログをダウンロードして解析
./scripts/analyze-cicd-errors.sh <run-id>

# Claude Codeで修正
/fix-cicd
```

### PR自動コメント

- PRを作成/更新すると自動的にコメントが投稿される
- Claude Codeで修正

### 自動修正

- CI/CDが失敗すると自動的に修正を試みる
- 修正できない場合はPRコメント

## セキュリティ考慮事項

1. **GitHub Token の管理**
   - `GITHUB_TOKEN` は読み取り専用で使用
   - PRへの書き込み権限のみ

2. **自動修正の制限**
   - 最大3回まで
   - mainブランチへの直接修正は禁止
   - レビューが必要な変更は自動修正しない

3. **ログの秘匿情報**
   - API鍵、パスワードは自動的にマスク
   - 環境変数は表示しない

## メトリクス

追跡する指標:

1. **エラー解析率**: 解析されたエラー数 / 総エラー数
2. **自動修正成功率**: 自動修正成功数 / 試行回数
3. **平均修正時間**: エラー発生から修正完了までの時間
4. **繰り返しエラー**: 同じエラーが複数回発生した回数

## 今後の拡張

1. **AI解析の統合**
   - Claude APIで複雑なエラーを解析
   - 修正候補を複数提案

2. **エラーパターン学習**
   - 過去のエラーと修正履歴から学習
   - 新しいパターンを自動認識

3. **チーム通知**
   - Slack/Teams連携
   - 担当者への自動アサイン

4. **ダッシュボード**
   - エラートレンド可視化
   - ホットスポット検出
