# DiagnoLeads Phase 2 Implementation Plan

**フェーズ**: 2 (Growth & Retention - 顧客価値最大化)
**期間**: 20週間（約5ヶ月）
**開始予定**: 2025年5月（Phase 1.5完了後）
**目標**: 顧客ROI向上とデータドリブン経営支援

---

## 📋 Executive Summary

Phase 2では、DiagnoLeadsの顧客価値を最大化する2つの主要機能を実装します：

1. **リード育成・マーケティングオートメーション** (10-12週間)
   - ドリップメールキャンペーン
   - リードスコアリングルールエンジン
   - 自動セグメント化
   - タスク管理・リマインダー

2. **高度なレポーティング・BI機能** (8-10週間)
   - カスタムレポートビルダー
   - スケジュールレポート配信
   - 予測分析（AI活用）
   - カスタムダッシュボード

**ビジネスインパクト**:
- 商談化率 +150%
- 営業生産性 +80%
- 顧客満足度 NPS +25ポイント
- 解約率 -30%
- LTV +60%

---

## 🎯 Phase 2 の目標

### ビジネス目標
- **商談化率**: Phase 1.5比 +150%
- **顧客ROI**: リード獲得コストあたりの商談数 +200%
- **NPS（顧客満足度）**: 50以上
- **機能利用率**: Professional以上のテナントの80%がオートメーションまたはBI機能を利用

### 技術目標
- **メール配信成功率**: 98%以上
- **スコア計算レスポンス**: <50ms
- **レポート生成時間**: <3秒（10,000レコード）
- **予測分析精度**: MAPE（平均絶対誤差率） <15%

---

## 📅 全体スケジュール（20週間）

### Week 1-12: リード育成・マーケティングオートメーション
### Week 11-20: 高度なレポーティング・BI
※ 並行開発期間: Week 11-12（両チームで協力）

```
Week  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Lead Nurturing    ████████████████████████████
Reporting BI                       ██████████████████████
Testing                                        ████████
Launch Prep                                          ████
```

---

## 🎯 Milestone 1: スコアリングエンジン（Week 1-3）

### 目標
リードスコアリング機能の実装により、ホットリード自動検出を実現

### タスク

#### Week 1: スコアリングルール基盤
- [ ] **ScoringRuleモデル作成**
  - データベーススキーマ
  - マイグレーション実行
- [ ] **LeadScoringServiceクラス実装**
  - `apply_scoring_rules()` - ルール適用
  - `check_hot_lead_threshold()` - ホットリード判定
- [ ] **スコア履歴記録**
  - `score_history` テーブル
  - スコア変動トラッキング
- [ ] **APIエンドポイント**
  - `GET /api/v1/automation/scoring-rules`
  - `POST /api/v1/automation/scoring-rules`

**成果物**:
- `backend/app/services/automation/scoring_service.py`
- スコアリングAPI
- DBマイグレーション

#### Week 2: スコアリングルール管理UI
- [ ] **スコアリングルール設定ページ**
  - ルール一覧表示
  - ルール作成フォーム
  - ルール編集・削除
- [ ] **ルールタイプUI**
  - 行動ベーススコアリング
  - 属性ベーススコアリング
  - マイナススコア
- [ ] **プレビュー機能**
  - ルール適用シミュレーション
  - 影響を受けるリード数表示

**成果物**:
- `frontend/src/features/automation/ScoringRulesManager.tsx`
- ルール設定UI

#### Week 3: ホットリード検出・通知
- [ ] **ホットリード検出ロジック**
  - 閾値チェック（デフォルト: 80点）
  - ステータス更新
- [ ] **通知システム統合**
  - メール通知
  - Slack通知
  - Teams通知（既存統合活用）
  - アプリ内通知
- [ ] **自動タスク生成**
  - ホットリード検出時にタスク作成
  - 営業担当者への自動割当
- [ ] **統合テスト**
  - スコア更新 → ホットリード化 → 通知

**成果物**:
- ホットリード検出システム
- 通知テンプレート 3件
- 統合テスト 5件

**Milestone 1 完了条件**:
- ✅ スコアリングルールが設定・適用できる
- ✅ ホットリード検出時に自動通知される
- ✅ スコア履歴が記録・表示される

---

## 🎨 Milestone 2: セグメンテーション（Week 4-6）

### 目標
動的セグメント機能により、リードの自動分類を実現

### タスク

#### Week 4: セグメントビルダー基盤
- [ ] **SegmentationServiceクラス実装**
  - `create_segment()` - セグメント作成
  - `get_matching_leads()` - マッチングリード取得
  - `refresh_dynamic_segments()` - 動的セグメント更新
- [ ] **条件評価エンジン**
  - SQLクエリ動的生成
  - AND/OR ロジック対応
  - 複数条件グループ
- [ ] **セグメントメンバーシップ管理**
  - メンバー追加・削除
  - 静的 vs 動的セグメント

**成果物**:
- `backend/app/services/automation/segmentation_service.py`
- セグメント管理API

#### Week 5: セグメントビルダーUI
- [ ] **セグメントビルダーページ**
  - 条件追加UI（ドラッグ&ドロップ風）
  - フィールド選択（スコア、業界、企業規模など）
  - オペレーター選択（equals, greater_than, contains など）
  - 値入力
- [ ] **プレビュー機能**
  - マッチするリード数表示
  - サンプルリード表示（最大10件）
- [ ] **動的/静的切り替え**
  - トグルスイッチ
  - 説明ツールチップ

**成果物**:
- `frontend/src/features/automation/SegmentBuilder.tsx`
- セグメント一覧・詳細ページ

#### Week 6: セグメント活用機能
- [ ] **セグメント自動更新バッチ**
  - 定期実行ジョブ（1時間ごと）
  - 動的セグメントのメンバー更新
- [ ] **セグメント別アクション**
  - セグメントからキャンペーン起動
  - セグメント一括エクスポート
  - セグメント統計表示
- [ ] **AIレコメンデーション**
  - セグメント提案（「高スコアIT業界」など）
- [ ] **統合テスト**
  - セグメント作成 → リード追加 → 条件変更 → 自動更新

**成果物**:
- セグメント自動更新ジョブ
- セグメント活用UI
- 統合テスト 8件

**Milestone 2 完了条件**:
- ✅ セグメントを自由に作成できる
- ✅ 動的セグメントが自動更新される
- ✅ セグメントからアクションを起動できる

---

## 📧 Milestone 3: キャンペーン管理（Week 7-9）

### 目標
ドリップメールキャンペーン機能の実装

### タスク

#### Week 7: キャンペーンエンジン
- [ ] **CampaignServiceクラス実装**
  - `create_campaign()` - キャンペーン作成
  - `enroll_lead()` - リード登録
  - `execute_step()` - ステップ実行
  - `schedule_next_step()` - 次ステップスケジュール
- [ ] **トリガー処理**
  - 診断完了トリガー
  - スコア閾値トリガー
  - セグメント追加トリガー
- [ ] **バックグラウンドジョブ**
  - Trigger.dev 統合
  - ステップ遅延実行

**成果物**:
- `backend/app/services/automation/campaign_service.py`
- キャンペーンAPI

#### Week 8: キャンペーンビルダーUI
- [ ] **キャンペーンビルダーページ**
  - トリガー設定UI
  - ステップ追加・編集（ドラッグ&ドロップ）
  - 遅延時間設定
  - メールテンプレート選択
- [ ] **条件分岐**
  - ステップごとの条件設定
  - 「スコア80以上ならスキップ」など
- [ ] **プレビュー・テスト送信**
  - キャンペーンフロー可視化
  - テストメール送信

**成果物**:
- `frontend/src/features/automation/CampaignBuilder.tsx`
- キャンペーン管理UI

#### Week 9: エンゲージメントトラッキング
- [ ] **メール開封・クリック追跡**
  - トラッキングピクセル挿入
  - リンククリック記録
- [ ] **エンゲージメント連動**
  - 開封時にスコア+5
  - クリック時にスコア+10
  - 高エンゲージメント時に営業通知
- [ ] **キャンペーン分析ダッシュボード**
  - 開封率、クリック率
  - コンバージョン率
  - ファネル可視化
- [ ] **統合テスト**
  - キャンペーン作成 → リード登録 → メール配信 → 開封トラッキング

**成果物**:
- エンゲージメントトラッキング機能
- キャンペーン分析UI
- E2Eテスト 10件

**Milestone 3 完了条件**:
- ✅ ドリップキャンペーンを作成できる
- ✅ リードが自動的にキャンペーンに登録される
- ✅ メール配信・エンゲージメント追跡が動作する

---

## ✅ Milestone 4: タスク管理・統合（Week 10-12）

### 目標
タスク自動生成とライフサイクル管理

### タスク

#### Week 10: タスク管理システム
- [ ] **TaskServiceクラス実装**
  - `create_hot_lead_task()` - ホットリードタスク生成
  - `assign_task()` - タスク割当（ラウンドロビン）
  - `complete_task()` - タスク完了
- [ ] **タスク管理UI**
  - タスク一覧（カンバンボード風）
  - タスク詳細モーダル
  - フィルター・ソート
- [ ] **通知・リマインダー**
  - 期日24時間前リマインダー
  - 期日超過エスカレーション

**成果物**:
- タスク管理システム
- `frontend/src/features/tasks/TaskBoard.tsx`

#### Week 11: ライフサイクル管理
- [ ] **ライフサイクルステージ定義**
  - 新規 → MQL → SQL → 商談 → 成約
- [ ] **自動ステージ遷移**
  - スコアベース遷移
  - 行動ベース遷移
- [ ] **ステージ別アクション**
  - MQL → 営業通知
  - SQL → CRM同期
  - 成約 → ウェルカムメール
- [ ] **パイプライン可視化**
  - ファネルチャート
  - ステージ別コンバージョン率

**成果物**:
- ライフサイクル管理機能
- パイプライン分析UI

#### Week 12: CRM統合・最終調整
- [ ] **CRM同期サービス**
  - Salesforce API統合
  - HubSpot API統合
  - 双方向同期
- [ ] **データマッピング**
  - フィールドマッピング設定
  - カスタムフィールド対応
- [ ] **ドキュメント整備**
  - オートメーション設定ガイド
  - ベストプラクティス
- [ ] **最終テスト**
  - E2Eテスト実行
  - パフォーマンステスト

**成果物**:
- CRM統合機能
- 完全なドキュメント

**Milestone 4 完了条件**:
- ✅ タスクが自動生成される
- ✅ ライフサイクルステージが自動遷移する
- ✅ CRMと双方向同期できる

---

## 📊 Milestone 5: カスタムレポートビルダー（Week 11-13）

### 目標
柔軟なレポート作成機能の実装

### タスク

#### Week 11: レポートエンジン基盤
- [ ] **DataAggregatorクラス実装**
  - データ集計エンジン
  - ディメンション・メトリクス処理
  - フィルター適用
- [ ] **ReportBuilderServiceクラス実装**
  - `create_report()` - レポート作成
  - `generate_report_data()` - データ生成
  - `format_for_chart()` - チャート形式変換
- [ ] **APIエンドポイント**
  - `POST /api/v1/reports/custom`
  - `GET /api/v1/reports/custom/{id}/data`

**成果物**:
- `backend/app/services/reporting/report_builder.py`
- レポートAPI

#### Week 12: レポートビルダーUI
- [ ] **レポートビルダーページ**
  - データソース選択
  - ディメンション・メトリクス選択（マルチセレクト）
  - チャートタイプ選択（アイコン表示）
- [ ] **フィルター設定**
  - 日付範囲ピッカー
  - セグメント選択
  - カスタム条件
- [ ] **リアルタイムプレビュー**
  - チャート即座に描画
  - Recharts ライブラリ使用

**成果物**:
- `frontend/src/features/reporting/ReportBuilder.tsx`
- チャートコンポーネント 6種類

#### Week 13: レポート管理機能
- [ ] **レポート一覧ページ**
  - カード表示（サムネイル付き）
  - 検索・フィルター
- [ ] **レポート詳細ページ**
  - フル画面チャート表示
  - インタラクティブ操作（ズーム、ドリルダウン）
  - エクスポートボタン（PDF、PNG、CSV）
- [ ] **共有機能**
  - 共有URL生成
  - 公開/非公開設定
- [ ] **統合テスト**
  - レポート作成 → データ生成 → エクスポート

**成果物**:
- レポート管理UI
- エクスポート機能
- 統合テスト 8件

**Milestone 5 完了条件**:
- ✅ カスタムレポートを作成できる
- ✅ 複数のチャートタイプに対応
- ✅ エクスポート・共有が可能

---

## 📅 Milestone 6: スケジュールレポート・エクスポート（Week 14-16）

### 目標
レポート自動配信とデータエクスポート機能

### タスク

#### Week 14: スケジュールレポート
- [ ] **ScheduledReportServiceクラス実装**
  - `create_schedule()` - スケジュール設定
  - `execute_scheduled_report()` - レポート実行
- [ ] **PDF/Excelエクスポート**
  - ReportExportService実装
  - WeasyPrint（PDF生成）
  - Pandas（Excel生成）
- [ ] **メール配信**
  - レポート添付メール送信
  - カスタマイズ可能な件名・本文

**成果物**:
- `backend/app/services/reporting/scheduled_report_service.py`
- レポートエクスポートサービス

#### Week 15: スケジュール設定UI
- [ ] **スケジュール設定ページ**
  - 配信頻度選択（日次、週次、月次）
  - 配信時刻選択
  - 受信者設定（メール、Slack）
- [ ] **配信履歴**
  - 過去の配信記録表示
  - ステータス（成功、失敗）
  - 再送信ボタン
- [ ] **テスト送信**
  - プレビューメール送信

**成果物**:
- `frontend/src/features/reporting/ScheduleSettings.tsx`
- 配信履歴UI

#### Week 16: データエクスポート
- [ ] **DataExportServiceクラス実装**
  - `export_leads()` - リードエクスポート
  - CSV、Excel、JSON対応
  - 大容量データ対応（バックグラウンドジョブ）
- [ ] **エクスポートUI**
  - エクスポート設定モーダル
  - カラム選択
  - フィルター適用
- [ ] **エクスポート履歴**
  - ダウンロードリンク（24時間有効）
- [ ] **統合テスト**
  - スケジュールレポート実行 → メール配信
  - 大容量エクスポート

**成果物**:
- データエクスポート機能
- エクスポート管理UI
- 統合テスト 10件

**Milestone 6 完了条件**:
- ✅ レポートが自動配信される
- ✅ データをエクスポートできる
- ✅ 大容量データに対応

---

## 🔮 Milestone 7: 予測分析（Week 17-18）

### 目標
AI活用の予測分析機能

### タスク

#### Week 17: 予測モデル実装
- [ ] **PredictiveAnalyticsServiceクラス実装**
  - `forecast_leads()` - リード獲得予測
  - `detect_anomalies()` - 異常検知
  - `analyze_trends()` - トレンド分析
- [ ] **時系列予測**
  - Exponential Smoothing
  - 信頼区間計算
- [ ] **異常検知**
  - 移動平均・標準偏差
  - 3σルール

**成果物**:
- `backend/app/services/reporting/predictive_analytics.py`
- 予測分析API

#### Week 18: 予測分析UI
- [ ] **予測分析ダッシュボード**
  - リード獲得予測グラフ（信頼区間付き）
  - トレンド分析チャート
  - 異常検知アラート
- [ ] **シナリオシミュレーション**
  - パラメータ調整（広告予算など）
  - Before/After比較
- [ ] **インサイト生成**
  - AIが自動生成したインサイト表示
  - レコメンデーション
- [ ] **統合テスト**
  - 予測計算 → 結果表示

**成果物**:
- `frontend/src/features/reporting/PredictiveAnalytics.tsx`
- 予測分析UI

**Milestone 7 完了条件**:
- ✅ リード獲得を予測できる
- ✅ 異常を検知できる
- ✅ トレンドを分析できる

---

## 📈 Milestone 8: カスタムダッシュボード・最終調整（Week 19-20）

### 目標
カスタムダッシュボード機能と最終調整

### タスク

#### Week 19: カスタムダッシュボード
- [ ] **ダッシュボードビルダー**
  - ウィジェット追加UI
  - グリッドレイアウトエディター（react-grid-layout）
  - ウィジェット設定
- [ ] **ウィジェットタイプ**
  - KPIカード
  - チャート
  - テーブル
  - テキストメモ
- [ ] **ダッシュボード管理**
  - 一覧・作成・編集・削除
  - デフォルトダッシュボード設定

**成果物**:
- `frontend/src/features/reporting/DashboardBuilder.tsx`
- カスタムダッシュボード機能

#### Week 20: 最終調整・リリース準備
- [ ] **パフォーマンス最適化**
  - クエリ最適化
  - キャッシュ導入
  - レポート生成高速化
- [ ] **ドキュメント整備**
  - レポート作成ガイド
  - オートメーション設定ガイド
  - APIドキュメント
- [ ] **E2Eテスト実行**
  - 全機能の統合テスト
- [ ] **セキュリティ監査**
  - データアクセス制御
  - エクスポート制限

**成果物**:
- 完全なドキュメント
- E2Eテストスイート
- パフォーマンスレポート

**Milestone 8 完了条件**:
- ✅ カスタムダッシュボードを作成できる
- ✅ すべての機能が統合され正常動作する
- ✅ ドキュメントが完成している

---

## 🧪 Testing & QA Plan

### 単体テスト（継続的）
- **カバレッジ目標**: 85%以上
- **重点領域**:
  - スコアリングロジック
  - セグメント条件評価
  - キャンペーンステップ実行
  - データ集計ロジック
  - 予測モデル

### 統合テスト（Week 12, 16, 20）
- キャンペーンエンロール → メール送信
- スコア更新 → ホットリード検出 → タスク作成
- レポート生成 → スケジュール配信
- データエクスポート（大容量）

### E2Eテスト（Week 20）
- **オートメーションフロー**:
  - スコアリングルール設定 → リード行動 → ホットリード化 → 営業通知
  - キャンペーン作成 → リード登録 → メール配信 → 開封トラッキング
- **レポーティングフロー**:
  - レポート作成 → スケジュール設定 → 自動配信
  - ダッシュボード作成 → ウィジェット配置 → データ表示

### パフォーマンステスト（Week 20）
- **負荷テスト**: 500同時ユーザー
- **スコア計算**: <50ms（1,000リード）
- **セグメント更新**: 10,000リード/秒
- **レポート生成**: <3秒（10,000レコード）

---

## 🚀 Launch Checklist

### Pre-Launch（Week 19-20）
- [ ] すべての機能が仕様通り動作
- [ ] E2Eテストがパス
- [ ] パフォーマンス目標達成
- [ ] セキュリティ監査完了
- [ ] ドキュメント完成
- [ ] エラーハンドリング・ロギング整備
- [ ] 監視・アラート設定（Sentry, Datadog）

### メール配信設定
- [ ] SendGrid / Amazon SES設定
- [ ] SPF/DKIM/DMARC設定
- [ ] バウンス処理設定
- [ ] 配信停止リンク実装

### データ処理
- [ ] バックグラウンドジョブ設定（Trigger.dev）
- [ ] データベースインデックス最適化
- [ ] クエリパフォーマンスチューニング

### マーケティング
- [ ] Phase 2リリース告知ブログ記事
- [ ] 既存顧客へのメール通知
- [ ] ウェビナー企画（新機能デモ）
- [ ] ケーススタディ作成

### Launch Day（Week 21予定）
- [ ] Phase 2機能を本番環境にデプロイ
- [ ] 機能フラグをON
- [ ] 監視ダッシュボードを確認
- [ ] カスタマーサポート体制を待機
- [ ] マーケティング施策実行

---

## 📊 Success Metrics & KPIs

### 初月（リリース後1ヶ月）
- **オートメーション機能利用率**: Professional以上のテナントの50%
- **キャンペーン作成数**: テナントあたり平均2個
- **レポート作成数**: テナントあたり平均3個
- **メール開封率**: 35%以上
- **メールクリック率**: 8%以上

### 3ヶ月後
- **商談化率**: Phase 1.5比 +100%（目標 +150%に向けて）
- **営業生産性**: +50%（目標 +80%に向けて）
- **顧客満足度（NPS）**: 45以上（目標 50に向けて）
- **機能利用率**: Professional以上のテナントの75%

### 6ヶ月後
- **商談化率**: Phase 1.5比 +150%
- **営業生産性**: +80%
- **顧客満足度（NPS）**: 50以上
- **解約率**: Phase 1.5比 -30%
- **LTV**: Phase 1.5比 +60%

---

## 🔧 Technical Debt & Future Improvements

Phase 2で対応しない項目（Phase 3以降に持ち越し）:

### オートメーション機能
- [ ] ビジュアルワークフローエディター（ノーコード）
- [ ] Webhookトリガー
- [ ] SMS・プッシュ通知対応
- [ ] AIベースのキャンペーン最適化

### レポーティング機能
- [ ] リアルタイムストリーミング分析
- [ ] 機械学習モデルのカスタマイズ
- [ ] 複雑なSQL クエリビルダー
- [ ] Tableau / Power BI統合

---

## 👥 Team & Responsibilities

### Backend Team（2名）
- **Lead Backend Engineer**: オートメーションエンジン、スコアリング、キャンペーン
- **Backend Engineer**: レポーティング、予測分析、エクスポート

### Frontend Team（2名）
- **Lead Frontend Engineer**: キャンペーンビルダー、レポートビルダー
- **Frontend Engineer**: ダッシュボード、セグメントビルダー

### Data Engineer（1名）
- データ集計・分析基盤
- 予測モデル実装
- パフォーマンス最適化

### QA/Testing（1名）
- テスト計画策定
- E2Eテスト実行
- パフォーマンステスト

### Product Manager（1名）
- 仕様確認
- ステークホルダー調整
- ローンチ計画

---

## 📚 References

### 仕様ドキュメント
- [Lead Nurturing & Automation Specification](../openspec/specs/features/lead-nurturing-automation.md)
- [Advanced Reporting & BI Specification](../openspec/specs/features/advanced-reporting-bi.md)

### 技術ドキュメント
- [Marketing Automation Best Practices](https://www.hubspot.com/marketing-automation)
- [Lead Scoring Guide](https://www.salesforce.com/resources/articles/lead-scoring/)
- [Time Series Forecasting](https://otexts.com/fpp3/)
- [Data Visualization Principles](https://www.interaction-design.org/literature/article/data-visualization-principles)

### プロジェクト管理
- [Phase 1.5 Implementation Plan](./IMPLEMENTATION_PLAN_PHASE1.5.md)
- [Production Deployment Guide](./PRODUCTION_DEPLOYMENT_GUIDE.md)

---

**次のステップ**: Phase 1.5完了後、Milestone 1からの実装開始！🚀
